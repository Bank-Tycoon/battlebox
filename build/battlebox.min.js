/*! battlebox.js - battlebox, Minified on 2015-11-19 */

_.mixin({deepClone:function(a){return JSON.parse(JSON.stringify(a))}});var maths={};maths.clamp=function(a,b,c){return Math.min(Math.max(a,b),c)},maths.heightOnSin=function(a,b,c,d,e,f){f=f||Math.sin;var g=c/d,h=a+(b-a)*g;return f(h*Math.PI)*e},maths.sizeFromAmountRange=function(a,b,c,d,e){var f=(c-d)/(e-d);return a+f*(b-a)},maths.colorBlendFromAmountRange=function(a,b,c,d,e){var f=(c-d)/(e-d);"#"==a.substring(0,1)&&(a=a.substring(1,7)),"#"==b.substring(0,1)&&(b=b.substring(1,7));var g=a.substring(0,2),h=a.substring(2,4),i=a.substring(4,6),j=b.substring(0,2),k=b.substring(2,4),l=b.substring(4,6),m=Math.abs(parseInt(parseInt(g,16)*f+parseInt(j,16)*(1-f))),n=Math.abs(parseInt(parseInt(h,16)*f+parseInt(k,16)*(1-f))),o=Math.abs(parseInt(parseInt(i,16)*f+parseInt(l,16)*(1-f))),p=maths.decimalToHex(m)+maths.decimalToHex(n)+maths.decimalToHex(o);return"#"+p},maths.decimalToHex=function(a,b){var c=Number(a).toString(16);for(b="undefined"==typeof b||null===b?b=2:b;c.length<b;)c="0"+c;return c},maths.idealTextColor=function(a){var b=150,c=maths.getRGBComponents(a),d=.299*c.R+.587*c.G+.114*c.B;return b>255-d?"#000000":"#ffffff"},maths.getRGBComponents=function(a){var b=a.substring(1,3),c=a.substring(3,5),d=a.substring(5,7);return{R:parseInt(b,16),G:parseInt(c,16),B:parseInt(d,16)}},maths.hexColorToRGBA=function(a,b){var c;if(!a)return"rgba(0,0,0,1)";var d,e;return 0==a.indexOf("rgb(")&&a.indexOf(",")>5?(d=a.substr(0,a.length-1),d=d.substr(4),e=d.split(","),c={R:e[0],G:e[1],B:e[2]}):0==a.indexOf("rgba(")&&a.indexOf(",")>5?(d=a.substr(0,a.length-1),d=d.substr(5),e=d.split(","),c={R:e[0],G:e[1],B:e[2]}):0==a.indexOf("#")?c=maths.getRGBComponents(a):(d=net.brehaut.Color(a).toString(),c=maths.getRGBComponents(d)),b=b||1,"rgba("+c.R+","+c.G+","+c.B+","+b+")"},maths.buildTransformFromTriangleToTriangle=function(a,b){var c=a[0].x,d=a[0].y,e=a[1].x,f=a[1].y,g=a[2].x,h=a[2].y,i=b[0].x,j=b[0].y,k=b[1].x,l=b[1].y,m=b[2].x,n=b[2].y,o=((i-k)*(d-h)-(i-m)*(d-f))/((c-e)*(d-h)-(c-g)*(d-f)),p=((i-k)*(c-g)-(i-m)*(c-e))/((d-f)*(c-g)-(d-h)*(c-e)),q=i-o*c-p*d,r=((j-l)*(d-h)-(j-n)*(d-f))/((c-e)*(d-h)-(c-g)*(d-f)),s=((j-l)*(c-g)-(j-n)*(c-e))/((d-f)*(c-g)-(d-h)*(c-e)),t=j-r*c-s*d;return[o,r,p,s,q,t]};var Helpers=Helpers||{};Helpers.radians=function(a){return a*Math.PI/180},Helpers.degrees=function(a){return 180*a/Math.PI},Helpers.between=function(a,b,c,d,e){if(!a.lastIndexOf||!a.indexOf)return a;var f=e?a.lastIndexOf(b):a.indexOf(b);if(!(f>=0))return"";if(a=a.substring(f+b.length),c){if(f=d?a.lastIndexOf(c):a.indexOf(c),!(f>=0))return"";a=a.substring(0,f)}return a},Helpers.sortWithConditions=function(a,b){b=b||"name";var c,d,e,f,g,h,i,j,k=[],l=[];for(c=0;c<a.length;c++)f=a[c],f.after||f.above?l.push(f):k.push(f);var m=0;for(c=0;c<l.length;c++){f=l[c],g=f.after||f.above,_.isArray(g)||(g=[g]),h=0;var n=0;for(d=0;d<g.length;d++)for(i=g[d],e=0;e<k.length;e++)if(j=k[e],i==j[b]){e+1>h&&(h=e+1),n++;break}n==g.length?k.splice(h,0,f):(k.push(f),m++)}for(c=k.length-m;c<k.length;c++){for(f=k[c],g=f.after||f.above,_.isArray(g)||(g=[g]),h=0,d=0;d<g.length;d++)for(i=g[d],e=0;e<k.length;e++)if(j=k[e],i==j[b]){e>h&&(h=e+1);break}k.splice(c,1),k.splice(h,0,f)}return k},Helpers.randomSetSeed=function(a){Helpers._randseed=a||42},Helpers.random=function(){Helpers._randseed=Helpers._randseed||42;var a=1e4*Math.sin(Helpers._randseed++);return a-Math.floor(a)},Helpers.randInt=function(a){return a=a||100,parseInt(Helpers.random()*a+1)},Helpers.randOption=function(a){var b=a.length;return a[Helpers.randInt(b)-1]},Helpers.dateFromPythonDate=function(a,b){"None"==a&&(a=void 0),null==a&&(a=void 0),""==a&&(a=void 0);var c=b;return a&&(a=a.replace(/p.m./,"pm"),a=a.replace(/a.m./,"am"),a=a.replace(/\. /," "),c=moment(a)),c&&c.isValid&&!c.isValid()&&(c=b||moment()),c},Helpers.knownFileExt=function(a){var b=",3gp,7z,ace,ai,aif,aiff,amr,asf,aspx,asx,bat,bin,bmp,bup,cab,cbr,cda,cdl,cdr,chm,dat,divx,dll,dmg,doc,docx,dss,dvf,dwg,eml,eps,exe,fla,flv,gif,gz,hqx,htm,html,ifo,indd,iso,jar,jp2,jpeg,jpg,kml,kmz,lnk,log,m4a,m4b,m4p,m4v,mcd,mdb,mid,mov,mp2,mp4,mpeg,mpg,msi,mswmm,ogg,pdf,png,pps,ppt,pptx,ps,psd,pst,ptb,pub,qbb,qbw,qxd,ram,rar,rm,rmvb,rtf,sea,ses,sit,sitx,ss,swf,tgz,thm,tif,tmp,torrent,ttf,txt,vcd,vob,wav,wma,wmv,wps,xls,xpi,zip,";return b.indexOf(","+a+",")>-1},Helpers.thousandsFormatter=function(a){return a>999?(a/1e3).toFixed(1)+"k":a},Helpers.expandExponential=function(a){if(1e20>a)return a;var a=a+"";return a=a.replace(/^([+-])?(\d+).?(\d*)[eE]([-+]?\d+)$/,function(a,b,c,d,e){var f=0>+e,g=c.length+ +e,a=(f?c:d).length,e=(e=Math.abs(e))>=a?e-a+f:0,h=new Array(e+1).join("0"),i=c+d;return(b||"")+(f?i=h+i:i+=h).substr(0,g+=f?h.length:0)+(g<i.length?"."+i.substr(g):"")})},Helpers.abbreviateNumber=function(a,b,c){1e6>a&&(a=c?parseInt(a):Helpers.round(a,1));var d=a;if(a>=1e4){a=Helpers.expandExponential(a);for(var e=b?[""," thousand"," million"," billion"," trillion"," quadrillion"," pentillion"," sextillion"," septillion"]:["","k","m","b","t","q","p","s","ss"],f=Math.floor((""+a).length/3),g="",h=2;h>=1;h--){g=parseFloat((0!=f?a/Math.pow(1e3,f):a).toPrecision(h));var i=(g+"").replace(/[^a-zA-Z 0-9]+/g,"");if(i.length<=2)break}d=g+e[f]}else d=d.toLocaleString();return d},Helpers.invertColor=function(a){var b=a;return b=b.substring(1),b=parseInt(b,16),b=16777215^b,b=b.toString(16),b=("000000"+b).slice(-6),b="#"+b},Helpers.rgb2hex=function(a){function b(a){return("0"+parseInt(a).toString(16)).slice(-2)}return"string"!=typeof a?a:("#"==a[0]&&(a=a.substr(1)),a&&-1==a.search("rgb")?(a=a.split(","),a.length>=3?"#"+b(a[0])+b(a[1])+b(a[2]):a):a?(a=a.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+))?\)$/),"#"+b(a[1])+b(a[2])+b(a[3])):a)},Helpers.getRGBComponents=function(a){var b=a.substring(1,3),c=a.substring(3,5),d=a.substring(5,7);return{R:parseInt(b,16),G:parseInt(c,16),B:parseInt(d,16)}},Helpers.idealTextColor=function(a){4===a.length&&(a="#"+a[1]+a[1]+a[2]+a[2]+a[3]+a);var b=105,c=Helpers.getRGBComponents(a),d=.299*c.R+.587*c.G+.114*c.B;return b>255-d?"#000000":"#ffffff"},Helpers.getColorWithBackground=function(a,b){var c=Helpers.rgb2hex(a),d=b?Helpers.invertColor(c):Helpers.idealTextColor("#"+c);return d},Helpers.getQueryString=function(){for(var a,b={},c=location.search.substring(1),d=/([^&=]+)=([^&]*)/g;a=d.exec(c);)b[decodeURIComponent(a[1])]=decodeURIComponent(a[2]);return b},Helpers.exists=function(){for(var a=!0,b=0;b<arguments.length;b++)if("undefined"==typeof arguments[b]){a=!1;break}return a},Helpers.upperCase=function(a,b){return"undefined"!=typeof a?b?a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}):a.charAt(0).toUpperCase()+a.slice(1):void 0},Helpers.MakeSureClassExists=function(pointer){var classArr=pointer.split("."),newClass={};if(classArr.length&&classArr.length>0){var rootClass=classArr[0];window[rootClass]?newClass=window[rootClass]:eval(rootClass+" = {}");for(var classEval=rootClass,i=1;i<classArr.length;i++)classEval+="['"+classArr[i]+"']","undefined"==eval("typeof "+classEval)&&eval(classEval+" = {}")}},Helpers.dateCameBefore=function(a){var b=!1,c=!1;if(a&&a.isValid?b=!0:a=moment(a),a&&a.isValid&&a.isValid()){var d=moment(),e=d.diff(a);e>0&&(c=!0)}else c="Invalid Date";return c},Helpers.buildBootstrapDropdown=function(a,b){var c=$("<span class='btn-group'>");$("<a class='btn dropdown-toggle btn-mini' data-toggle='dropdown' href='#'>"+a+"<span class='caret'></span></a>").appendTo(c);var d=$("<ul class='dropdown-menu'>").appendTo(c);return _.each(b,function(a){var b=$("<li>").appendTo(d),c=$("<a>").attr({target:"_blank",alt:a.alt||a.name||""}).text(a.title||"Item").appendTo(b);a.url&&c.attr({href:a.href}),a.onclick&&c.on("click",a.onclick)}),c},Helpers.buildBootstrapInputDropdown=function(a,b,c){var d=$("<span class='input-append btn-group'>"),e=$("<a class='btn dropdown-toggle btn-mini' data-toggle='dropdown' href='#'>").css({"float":"none"}).appendTo(d),f=$("<span>").text(a).appendTo(e);$("<span>").addClass("caret").appendTo(e);var g=$("<ul class='dropdown-menu'>").appendTo(d);return _.each(b,function(a){var b=$("<li>").appendTo(g),d=$("<a>").attr({alt:a.alt||a.name||""}).attr({href:"#"}).on("click",function(){var a=$(this).text();c.val(a),f.text(a)}).appendTo(b);a.imgSrc&&$("<img>").attr({src:a.imgSrc}).appendTo(d),$("<span>").text(a.title||"Item").appendTo(d)}),d},Helpers.tryToMakeDate=function(a,b){var c,d=b&&b.toLowerCase?b.toLowerCase():"";if(d&&("date"==d||"created"==d||"updated"==d||"datetime"==d)){var e=moment(a);e.isValid()&&(c=a+" <b>("+e.calendar()+")</b>")}return c||a},Helpers.randomLetters=function(a){var b="";a=a||1;for(var c=0;a>c;c++)b+=String.fromCharCode("a".charCodeAt(0)+26*Math.random()-1);return b},Helpers.pluralize=function(a){if(void 0===a)return a;var b=["equipment","information","rice","money","species","series","gold","cavalry","fish","sheep","moose","deer","news","food","wood","ore","piety","land"],c=[[new RegExp("(m)an$","gi"),"$1en"],[new RegExp("(pe)rson$","gi"),"$1ople"],[new RegExp("(child)$","gi"),"$1ren"],[new RegExp("^(ox)$","gi"),"$1en"],[new RegExp("(ax|test)is$","gi"),"$1es"],[new RegExp("(octop|vir)us$","gi"),"$1i"],[new RegExp("(alias|status)$","gi"),"$1es"],[new RegExp("(bu)s$","gi"),"$1ses"],[new RegExp("(buffal|tomat|potat)o$","gi"),"$1oes"],[new RegExp("([ti])um$","gi"),"$1a"],[new RegExp("sis$","gi"),"ses"],[new RegExp("(?:([^f])fe|([lr])f)$","gi"),"$1$2ves"],[new RegExp("(hive)$","gi"),"$1s"],[new RegExp("([^aeiouy]|qu)y$","gi"),"$1ies"],[new RegExp("(x|ch|ss|sh)$","gi"),"$1es"],[new RegExp("(matr|vert|ind)ix|ex$","gi"),"$1ices"],[new RegExp("([m|l])ouse$","gi"),"$1ice"],[new RegExp("(quiz)$","gi"),"$1zes"],[new RegExp("s$","gi"),"s"],[new RegExp("$","gi"),"s"]],d=_.indexOf(b,a.toLowerCase())>-1;if(!d)for(var e=0;e<c.length;e++)if(a.match(c[e][0])){a=a.replace(c[e][0],c[e][1]);break}return a},Helpers.stringAfterString=function(a,b,c){var d=a.indexOf(b);return Helpers.exists(d)&&d>-1?a.substr(d+b.length):c||a},Helpers.isNumeric=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},Helpers.nameOfUSState=function(a,b){var c={AL:"Alabama",AK:"Alaska",AZ:"Arizona",AR:"Arkansas",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",DC:"District of Columbia",FL:"Florida",GA:"Georgia",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",RI:"Rhode Island",SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VA:"Virginia",WA:"Washington",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming"},d=c[a.toUpperCase()],e="";return d&&(e=b?", "+d:d),e},Helpers.getQueryVariable=function(a){for(var b=window.location.search.substring(1),c=!1,d=b.split("&"),e=0;e<d.length;e++){var f=d[e].split("=");if(f[0]==a){c=f[1];break}}return c},Helpers.createCSSClass=function(a,b){if(document.styleSheets&&0!=document.getElementsByTagName("head").length){var c,d,e;if(document.styleSheets.length>0)for(g=0;g<document.styleSheets.length&&(document.styleSheets[g].disabled||(e=document.styleSheets[g].media,d=typeof e,"string"==d?(""==e||-1!=e.indexOf("screen"))&&(c=document.styleSheets[g]):"object"==d&&e.mediaText&&(""==e.mediaText||-1!=e.mediaText.indexOf("screen"))&&(c=document.styleSheets[g]),!Helpers.exists(c)));g++);if(Helpers.exists(c)){var f=document.createElement("style");for(f.type="text/css",document.getElementsByTagName("head")[0].appendChild(f),g=0;g<document.styleSheets.length;g++)document.styleSheets[g].disabled||(c=document.styleSheets[g]);e=c.media,d=typeof e}var g;if("string"==d){for(g=0;g<c.rules.length;g++)if(c.rules[g].selectorText.toLowerCase()==a.toLowerCase())return void(c.rules[g].style.cssText=b);c.addRule(a,b)}else if("object"==d){for(g=0;g<c.cssRules.length;g++)if(c.cssRules[g].selectorText&&c.cssRules[g].selectorText.toLowerCase()==a.toLowerCase())return void(c.cssRules[g].style.cssText=b);c.insertRule(a+"{"+b+"}",0)}}},Helpers.loadCSSFiles=function(a){"string"==typeof a&&(a=[a]),_.isArray(a)||(a=[]);for(var b=0;b<a.length;b++){var c=document.createElement("link");c.setAttribute("rel","stylesheet"),c.setAttribute("type","text/css"),c.setAttribute("href",a[b]),document.getElementsByTagName("head")[0].appendChild(c)}},Helpers.directoryOfPage=function(a){a=a||document.location.href;var b=a.lastIndexOf("/");return a.substr(0,b+1)},Helpers.randomcolor=function(a){if(!Helpers.exists(a))return"#"+Math.floor(16777215*Math.random()).toString(16);var b=[256*Math.random(),256*Math.random(),256*Math.random()],c=[51*a,51*a,51*a],d=[b[0]+c[0],b[1]+c[1],b[2]+c[2]].map(function(a){return Math.round(a/2)});return"rgb("+d.join(",")+")"},Helpers.randRange=function(a,b,c){var d=a+Math.random()*(b-a+1);return Helpers.exists(c)?Math.round(d-.5):d.toFixed(c)},Helpers.round=function(a,b){return Math.round(a*Math.pow(10,b))/Math.pow(10,b)},Helpers.hexFromDec=function(a){var b=Math.round(a).toString(16);return b.length>1||(b="0"+b),b},Helpers.randomcolor_basedon=function(a){a=a||"#505050",0==a.indexOf("#")&&(a=a.substr(1)),a.length&&3==a.length&&(a=a.substr(0,1)+"0"+a.substr(1,1)+"0"+a.substr(2,1)+"0");var b=parseInt(a.substr(0,2),16),c=parseInt(a.substr(2,2),16),d=parseInt(a.substr(4,2),16),e=16;return b=Helpers.hexFromDec(b+Helpers.randRange(0,e)-e/2),c=Helpers.hexFromDec(c+Helpers.math.randRange(0,e)-e/2),d=Helpers.hexFromDec(d+Helpers.math.randRange(0,e)-e/2),"#"+b+c+d},Helpers.color_transparency=function(a,b){a=a||"#505050",0==a.indexOf("#")&&(a=a.substr(1)),a.length&&3==a.length&&(a=a.substr(0,1)+"0"+a.substr(1,1)+"0"+a.substr(2,1)+"0");var c=parseInt(a.substr(0,2),16),d=parseInt(a.substr(2,2),16),e=parseInt(a.substr(4,2),16);return"rgba("+c+","+d+","+e+","+b+")"},Helpers.steppedGYR=function(a){a=a||0;var b;return b=.5>=a?Helpers.blendColors("#00ff00","#ffff00",2*a):Helpers.blendColors("#ffff00","#ff0000",2*(a-.5))},Helpers.blendColors=function(a,b,c){if("undefined"==typeof Colors)throw"Requires colors.min.js library";if(!a||!b)return a;a=0==a.indexOf("#")?a=Colors.hex2rgb(a):Colors.name2rgb(a),b=0==b.indexOf("#")?b=Colors.hex2rgb(b):Colors.name2rgb(b);var d=(b.R-a.R)*c,e=(b.G-a.G)*c,f=(b.B-a.B)*c,g=Colors.rgb2hex(parseInt(a.R+d),parseInt(a.G+e),parseInt(a.B+f));return 0!=g.indexOf("#")&&(g=a),g},Helpers.bw=function(a){if("undefined"==typeof Colors)throw"Requires colors.min.js library";var b=Colors.hex2rgb(a);if(!b||!b.a)return"rgb(0,0,0)";b=b.a;var c,d=function(a,b){var c=Math.abs,d=(299*a[0]+587*a[1]+114*a[2])/1e3,e=(299*b[0]+587*b[1]+114*b[2])/1e3,f=Math.round(Math.abs(d-e)),g=c(a[0]-b[0])+c(a[1]-b[1])+c(a[2]-b[2]);return[f,g]},e=[255,255,255],f=[0,0,0];if(b[1]>200&&b[0]+b[2]<50)c=f;else{var g=d(f,b),h=d(e,b);c=4*g[0]+g[1]>4*h[0]+h[1]?f:4*h[0]+h[1]>4*g[0]+g[1]?e:g[0]<h[0]?e:f}return"rgb("+c.join(",")+")"},Helpers.removeMobileAddressBar=function(a){function b(){window.scrollTo(0,0),document.body.style.height="100%",/(iphone|ipod)/.test(navigator.userAgent.toLowerCase())||document.body.parentNode&&(document.body.parentNode.style.height="100%")}a?b():(setTimeout(b,700),setTimeout(b,1500))},Helpers.orientationInfo=function(a,b){a=a||$(window).width(),b=b||$(window).height();var c=a>b?"horizontal":"vertical";return{layout:c,ratio:a/b}},Helpers.dots=function(a){for(var b="",c=0;a>c;c++)c%5==0&&(b+=" "),b+="&#149;";return 0==a&&(b="0"),b},Helpers.isIOS=function(){navigator.userAgent.toLowerCase().match(/(iphone|ipod|ipad)/)},Helpers.exists=function(){for(var a=!0,b=0;b<arguments.length;b++)if("undefined"==typeof arguments[b]){a=!1;break}return a},Helpers.distanceXY=function(a,b){return Math.sqrt((a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y))},Helpers.isInArray=function(a,b,c){if(!Helpers.exists(a)||!Helpers.exists(b))return!1;Helpers.isArray(a)||(a=[a]),Helpers.isArray(b)||(b=[b]);for(var d=!1,e=0;e<a.length;e++)for(var f=0;f<b.length;f++){var g=a[e],h=b[f];if(c&&"string"==typeof g&&"string"==typeof h){if(g.toLowerCase()==h.toLowerCase()){d=!0;break}}else if(g==h){d=!0;break}}return d},function(a){a.fn.copyEventTo=function(b,c,d){var e=[];return this.each(function(){var a=jQuery._data(this,"events");if("object"==typeof a){var c=a[b];if("object"==typeof c)for(var d=0;d<c.length;d++)e.push(a[b][d].handler)}}),"string"==typeof c?c=a(c):"object"==typeof c&&"string"==typeof c.tagName&&(c=a(c)),d===!0&&c.off(b),c.each(function(){for(var a=0;a<e.length;a++)c.bind(b,e[a])}),this}}(jQuery),function(){if("performance"in window==0&&(window.performance={}),Date.now=Date.now||function(){return(new Date).getTime()},"now"in window.performance==0){var a=Date.now();performance.timing&&performance.timing.navigationStart&&(a=performance.timing.navigationStart),window.performance.now=function(){return Date.now()-a}}}();var Battlebox=function(a,b,c,d){function e(a,b,c){return this.version=p+" (version "+m+") - "+n+" by "+o,this.timing_log=[],this.game_options=null,this.times_game_drawn=0,this.initialization_seed=null,this.display=null,this.engine=null,this.map={},this.open_space=[],this.entities=[],this.api(a,b,c)}function f(a){return ROT.RNG.getUniform()}function g(a,b){return a=a||100,parseInt(f(b)*a+1)}function h(a,b,c){var d=a.length,e=g(d,b)-1,f=a[e];return c&&f==c&&(e=(e+1)%d,f=a[e]),f}function i(a,b,c,d,e){var g=1;d=d||0,e=e||1;for(var h=e-d,i=(a-d)/h,j=0;b>j;j++){var k=f(c);Math.abs(k-i)<Math.abs(g-i)&&(g=k)}return g*h+d}function j(a,b,c,d){c=c||5;var e=b*a,f=i(.5,c,d);return e*f*2}function k(a,b,c,d){var e=a+f(c)*(b-a+1);return void 0!==d?Math.round(e-.5):e.toFixed(d)}function l(a,b,c){var d=0;if(100>a)for(var e=0;a>e;e++)f(c)<b&&d++;else d=.07>b||b>.93?j(a,b,3,c):i(a*b,Math.pow(a,.5),c,0,a);return Math.round(d)}var m="0.0.3",n="HTML game engine to simulate a battlefield for multiple troops to combat upon.",o="Jay Crossler - http://github.com/jaycrossler",p="battlebox.js",q={},r={};return e.prototype.api=function(a,c,d){if("get_private_functions"==a)return this._private_functions;if("add_game_option"==a)r[c]=r[c]||[],b.isArray(d)?r[c]=r[c].concat(d):r[c].push(d);else if("set_game_option"==a)r[c]=d;else{if("get_game_options"==a)return r;if("get_game_option_category"==a)return r[c];""==a||this.drawOrRedraw(a,c,d)}},e.prototype.data=q,e.prototype.initializeOptions=function(a,b){"game_options"==a&&(r=b)},e.prototype.drawOrRedraw=function(c){var d=window.performance.now(),e=this;null===e.game_options&&(e.initialization_seed=null),e.initialization_options=c||e.initialization_options||{},e.game_options=a.extend({},e.game_options||r,c||{}),c=c||{};var f=c.rand_seed||e.initialization_seed||Math.floor(1e5*Math.random());if(e.initialization_seed=f,e.initialization_options.rand_seed=f,e.randomSetSeed(f),!e.data.gui_drawn&&e._private_functions.initialize_ui_display&&e._private_functions.load){var g=e._private_functions.load(e,"localStorage");e._private_functions.initialize_data(e),g||e._private_functions.initialize_ui_display(e),e.data.gui_drawn=!0}b.each(e.game_options.functions_on_setup,function(a){a(e)}),e.start(e.game_options);var h=window.performance.now(),i=h-d;e.timing_log.push({name:"Game UI built",elapsed:i,times_redrawn:e.times_game_drawn})},e.prototype.log=function(a,d){var e="Battlebox: [seed:"+this.game_options.rand_seed+" #"+this.times_game_drawn+"]";return b.each(this.timing_log,function(a){e+="exception"==a.name?a.ex&&a.ex.name?"\n -- EXCEPTION: "+a.ex.name+", "+a.ex.message:a.msg?"\n -- EXCEPTION: "+a.msg:"\n -- EXCEPTION":a.elapsed?"\n - "+a.name+": "+c.round(a.elapsed,4)+"ms":"\n - "+a.name}),a&&console.log(e),d&&(e=e.replace(/\n/g,"<br/>")),e},e.prototype.logMessage=function(a,c){b.isString(a)&&(a={name:a}),this.timing_log.push(a),c&&console.log(JSON.stringify(a)),this._private_functions.log_display&&this._private_functions.log_display(this)},e.prototype.lastTimeDrawn=function(){var a=0,c=b.last(this.timing_log);return c&&(a=c.elapsed),a},e.prototype.getSeed=function(a){var b=this.initialization_options||{};return a?JSON.stringify(b):b},e.prototype.start=function(a){if(!this._private_functions.start_game_loop)throw"Game loop not found";this._private_functions.start_game_loop(this,a)},e.prototype.stop=function(){this._private_functions.stop_game_loop&&this._private_functions.stop_game_loop(this)},e.prototype.randomSetSeed=function(a){this.game_options=this.game_options||{},this.game_options.rand_seed=a||Math.random(),ROT.RNG.setSeed(this.game_options.rand_seed)},e.prototype._private_functions={random:f,randInt:g,randOption:h,randRange:k,randManyRolls:l,randHistogram:i},e}($,_,Helpers,maths);Battlebox.initializeOptions=function(a,b){var c=new Battlebox("");c.initializeOptions(a,b)},function(a){var b=new a("get_private_functions");b.battle={},b.battle.fight=function(a,c,d){var e=0,f=0;_.each(c.forces,function(a){e+=(a.count||1)*(a.strength||1),f+=(a.count||1)*(a.defense||1),a.mode="attacking"});var g=0,h=0;_.each(d.forces,function(a){g+=(a.count||1)*(a.strength||1),h+=(a.count||1)*(a.defense||1),a.mode="defending"});var i=[].concat(c.forces,d.forces);i.sort(function(a,b){var c=a.initiative||a.speed||40,d=b.initiative||b.speed||40;return d>c});for(var j=0;j<i.length;j++){var k=i[j];if(!k.dead)for(var l=0;l<k.count;l++){var m="attacking"==k.mode?d.forces:c.forces;if(!m.length)break;var n=b.randOption("attacking"==k.mode?d.forces:c.forces),o=n.defense||1;n.protected_by_walls&&(o+=o*n.protected_by_walls*.5),n.in_towers&&(o+=o*n.in_towers*.2);var p=k.strength/o,q=p>=1?!0:b.random()<=p;if(q){if(n.count--,n.count<=0){var r=_.indexOf(i,n);r>-1&&(i[r].dead=!0),"attacking"==k.mode?d.forces=_.reject(d.forces,n):c.forces=_.reject(c.forces,n)}var s=k.defense||1;k.protected_by_walls&&(s+=s*k.protected_by_walls*.5);var t=.2*n.strength/s;if(b.random()<=t&&(k.count--,k.count<=0)){var r=_.indexOf(i,k);r>-1&&(i[r].dead=!0),"attacking"==k.mode?c.forces=_.reject(c.forces,k):d.forces=_.reject(d.forces,k)}}}}},b.entity_attacks_entity=function(a,c,d,e){c._data.troops=c._data.troops||{},d._data.troops=d._data.troops||{},e=e||b.log_message_to_user;var f=c._data.name||"Attacker",g=c._data.side||"Side 1",h=d._data.name||"Defender",i=d._data.side||"Side 2",j=0;_.each(c.forces,function(a){j+=a.count||0});var k=0;if(_.each(d.forces,function(a){k+=a.count||0}),0>=j||0>=k)return!0;b.battle.fight(a,c,d);var l=0;_.each(c.forces,function(a){l+=a.count||0});var m=0;_.each(d.forces,function(a){m+=a.count||0});var n,o,p="",q="<span style='background-color:"+c._data.side+"'>"+f+" (["+(c._symbol||"@")+"] was size "+j+", now "+l+")</span>",r="<span style='background-color:"+d._data.side+"'>"+h+" (["+(d._symbol||"@")+"] was size "+k+", now "+m+")</span>",s=j-l,t=k-m;t>=s?(p=q+" WINS attacking "+r,c.fights_won=c.fights_won||0,c.fights_won++,d.fights_lost=d.fights_lost||0,d.fights_lost++,e(a,p,3,g)):(p=q+" LOST attacking "+r,d.fights_won=d.fights_won||0,d.fights_won++,c.fights_lost=c.fights_lost||0,c.fights_lost++,e(a,p,3,i)),0>=l&&(c.is_dead=!0,b.remove_entity(a,c)),0>=m&&(d.is_dead=!0,b.remove_entity(a,d)),n=b.find_unit_by_filters(a,c,{side:"enemy",return_multiple:!0,only_count_forces:!0}),0==n.target.length&&(o=c._data.side);var u=b.find_unit_by_filters(a,d,{side:"enemy",return_multiple:!0,only_count_forces:!0});return 0==u.target.length&&(o=d._data.side),o&&b.game_over(a,o),d.is_dead}}(Battlebox),function(a){var b=new a("get_private_functions"),c={};b.add_main_city_population=function(a,c){a.data.buildings[0].population+=c;for(var d=0;d<b.rows(a);d++)for(var e=d%2;e<b.cols(a);e+=2)a.cells[e][d].population=0;b.generate_buildings(a),b.draw_whole_map(a),console.log("Pop now at: "+a._private_functions.population_counter(a))},b.initialize_ui_display=function(a){var c=b.draw_initial_display(a,{});c.addEventListener("mousemove",function(c){var d=a.display.eventToPosition(c);b.highlight_position(a,d),b.show_info(a,d)})},b.update_ui_display=function(a){c.turn_counter.text("Turn: "+a.data.tick_count)},b.draw_initial_display=function(a,d){c.canvas_holder=$("#container"),c.message_display=$("#message_display").appendTo(c.canvas_holder),a.display=new ROT.Display({transpose:a.game_options.transpose,width:b.cols(a),height:b.rows(a),fontSize:a.game_options.cell_size,layout:"hex",border:void 0!==a.game_options.cell_border?a.game_options.cell_border:null,spacing:a.game_options.cell_spacing||.88});var e=a.display.getContainer();c.canvas_holder.append(e),c.info_box=$("<div>").appendTo(c.canvas_holder);var f=$("#unit_list");return c.unit_holder=$("<div>").appendTo(f),c.unit_dead_holder=$("<div>").appendTo(f),c.unit_dead_holder_title=$("<div>").text("Dead Units:").hide().appendTo(c.unit_dead_holder),ROT.RNG.setSeed(a.data.rand_seed),b.generate_base_map(a),b.generate_water_layers(a),b.generate_buildings(a),b.draw_whole_map(a),ROT.RNG.setSeed(a.data.fight_seed||a.data.rand_seed),b.build_units_from_list(a,a.data.forces),b.build_scheduler(a),b.add_screen_scheduler(a),c.logs=$("<div>").css({color:"gray"}).appendTo(c.message_display),a.logMessage(a.log()),c.play_pause_button=$("<button>").text("Pause").on("click",function(){"Pause"==c.play_pause_button.text()?(c.play_pause_button.text("Play"),b.stop_game_loop(a)):(c.play_pause_button.text("Pause"),b.start_game_loop(a))}).appendTo(c.canvas_holder),_.each([2e3,1e3,500,200,50],function(b,d){$("<button>").text(_.str.repeat(">",d+1)).on("click",function(){a.game_options.delay_between_ticks=b}).appendTo(c.canvas_holder)}),$("<button>").text("Add 100 people").on("click",function(){b.add_main_city_population(a,100)}).appendTo(c.canvas_holder),$("<button>").text("Add 1000 people").on("click",function(){b.add_main_city_population(a,1e3)}).appendTo(c.canvas_holder),c.turn_counter=$("<span>").text("Turn: 0").appendTo(c.canvas_holder),e},b.rows=function(a){return a.game_options.transpose?a.game_options.cols:a.game_options.rows},b.cols=function(a){return a.game_options.transpose?a.game_options.rows:a.game_options.cols},b.draw_whole_map=function(a){for(var c=0;c<b.rows(a);c++)for(var d=c%2;d<b.cols(a);d+=2)b.draw_tile(a,d,c)},b.draw_tile=function(a,c,d,e,f,g,h){var i=!1;f||g||(i=!0);var j=a.cells[c];if(j&&(j=j[d]),j){if(i){"city"==j.type&&(g="#DE8275");var k=b.tile_has(j,"farm",!0);if(b.tile_has(j,"wall"))g="black",e="X",f="white";else if(b.tile_has(j,"mine"))g="#4c362c";else if(b.tile_has(j,"dock"))g="#86fffc",e="=";else if(k){var l=Math.min(.4,.03*k);g=net.brehaut.Color("#CCC4B7").darkenByRatio(l).toString()}var m=!1;if(_.each(b.entities(a),function(a){a&&a.x==c&&a.y==d&&a._draw&&(a._draw(a.x,a.y),m=!0)}),m)return;var n=b.tile_has(j,"river");if("lake"==j.name){if(e=j.symbol||e,!g){var o=j.data.depth||1;g=net.brehaut.Color(j.color||"#04e").darkenByRatio(.2*o)}}else if(n&&(e=e||n.symbol,!g)){var o=n.depth||1;g=net.brehaut.Color("#03f").darkenByRatio(.2*o)}var p=0;j.population&&(f=Helpers.blendColors("black","red",j.population/300),j.population>1e3?(f="orange",e="█",p=.6):j.population>500?(f="orange",e="▓",p=.5):j.population>300?(e="▓",p=.4):j.population>150?(e="▄",p=.3):j.population>50?(e="▒",p=.2):j.population>10&&(e="░",p=.1)),void 0===e&&(e=j?j.symbol||" ":" ");var q=g;q||(q=j?j.color||"#000":" "==e?["#cfc","#ccf0cc","#dfd","#ddf0dd"].random():"#000"),!f&&b.tile_has(j,"unit corpse")&&(e="x");var r=!1,s=!1,t=b.tile_has(j,"path");i&&t&&(e=t.symbol||"",q=net.brehaut.Color(q).blend(net.brehaut.Color("#A2BB9B"),.7).toString(),(b.tile_has(j,"river")||j.data&&j.data.water)&&(r=!0),(b.tile_has(j,"wall")||b.tile_has(j,"tower"))&&(s=!0));var u=b.tile_has(j,"road");i&&u&&(e=u.symbol||":",q=net.brehaut.Color(q).blend(net.brehaut.Color("#DF8274"),.8).toString(),f="#000",(b.tile_has(j,"river")||j.data&&j.data.water)&&(r=!0),(b.tile_has(j,"wall")||b.tile_has(j,"tower"))&&(s=!0)),i&&b.tile_has(j,"storage")&&(e="o",q=net.brehaut.Color(q).blend(net.brehaut.Color("yellow"),.1).toString()),i&&b.tile_has(j,"looted")&&(e=".",q=net.brehaut.Color(q).blend(net.brehaut.Color("black"),.8).toString()),i&&b.tile_has(j,"pillaged")&&(e="'",q=net.brehaut.Color(q).blend(net.brehaut.Color("red"),.8).toString()),b.tile_has(j,"looted")&&b.tile_has(j,"pillaged")&&(e=";"),r&&(q=net.brehaut.Color(q).blend(net.brehaut.Color("brown"),.8).toString(),e="=",f="#fff"),s&&(q=net.brehaut.Color(q).blend(net.brehaut.Color("black"),.8).toString(),e="O",f="#fff"),b.tile_has(j,"tower")&&(e="╠╣"),b.tile_has(j,"river")&&b.tile_has(j,"wall")&&(e="{}"),p&&(q=net.brehaut.Color(q).blend(net.brehaut.Color("brown"),p).toString()),q.toString&&(q=q.toString())}else q=g;f=f||"#000",_.each(a.game_options.hex_drawing_callbacks,function(b){var c=b(a,j,e,f,q);c&&(e=c.text||e,f=c.color||f,q=c.bg||q)}),h?h(c,d,e,f,q):a.display.draw(c,d,e,f,q)}},b.log_display=function(a){if(c.logs||(c.logs=$("#logs")),c.logs){var b="<b>Battlebox: [seed:"+a.game_options.rand_seed+"]</b>",d=_.last(a.timing_log,5);_.each(d.reverse(),function(a){b+="exception"==a.name?a.ex&&a.ex.name?"<br/> -- EXCEPTION: "+a.ex.name+", "+a.ex.message:a.msg?"<br/> -- EXCEPTION: "+a.msg:"<br/> -- EXCEPTION":a.elapsed?"<br/> - "+a.name+": "+Helpers.round(a.elapsed,4)+"ms":"<br/> - "+a.name}),c.logs.html(b)}else console.log("NOTE: No Log div to write to.")};var d=null;b.highlight_position=function(a,c){d&&2==d.length&&b.draw_tile(a,d[0],d[1]),2==c.length?(d=c,b.draw_tile(a,c[0],c[1],void 0,void 0,"orange")):d=null},b.log_message_to_user=function(a,b,d,e){if(!(d<(a.game_options.log_level_to_show||2))){var f=$("<div>").html(b).prependTo(c.message_display);4==d&&f.css({backgroundColor:e||"red",color:"black",border:"4px solid gold",fontSize:"1.3em"}),3==d&&f.css({backgroundColor:e||"orange",color:"black"}),2==d&&f.css({color:"red"}),1==d&&f.css({color:"orange"})}},b.game_over_loot_report=function(a){var c="",d=a.data.game_over_winner,e={};_.each(a.entities,function(a){if(a&&a._data&&a._data.player&&a.loot)for(var b in a.loot)e[b]=e[b]||0,e[b]+=a.loot[b]});var f=[];for(var g in e)f.push(Helpers.abbreviateNumber(e[g])+" "+Helpers.pluralize(g));var h=[],i=0,j=0,k=0;_.each(a.data.buildings,function(c){if("city"==c.type||"city2"==c.type){_.each(c.tiles||[],function(c){i++;var d=a.cells[c.x][c.y];(b.tile_has(d,"pillaged")||b.tile_has(d,"looted"))&&(j++,k+=d.population)});var d=Math.round(j/i*100),e=d+"% of "+(c.title||c.name)+" destroyed, ";e+=Helpers.abbreviateNumber(k)+" population displaced",h.push(e)}}),h.length&&(c+="<b>Cities:</b><br/> "+h.join("<br/>")),f.length&&(c+="<hr/><b>Surviving invaders looted:</b><br/>"+f.join(", ")),b.log_message_to_user(a,c,4,"No one"==d?"gray":d)},b.game_over=function(a,c){var d=a.game_options.delay_to_pillage||50;a.data.game_over_at_tick=a.data.tick_count+d,a.data.game_over_winner=c,c||(c="No one");var e="Game Over!  "+c+" wins by defeating all enemies!";e+=" ("+a.data.tick_count+" rounds)",e+="<br/><i>"+d+" more rounds to gather final pillage</i>",b.log_message_to_user(a,e,4,"No one"==c?"gray":c),a.game_options.game_over_function&&a.game_options.game_over_function(a)},b.show_info=function(a,d){function e(a,b,c,d,e){var f=_.str.titleize(h.name);l.length&&(f+=", "+l.join(", ")),c&&(f+=" ["+c+"]");var g=e?Helpers.bw(e):null;"rgb(255,255,255)"==g&&(d=g),k.css({backgroundColor:e,color:d}).text(f)}var f=d[0],g=d[1],h={},i=b.tile(a,f,g);if(i){h=_.clone(i);var j=JSON.stringify(h);c.info_box.empty();var k=$("<span>").addClass("tile_info").text(_.str.titleize(h.name)).attr("title",j).appendTo(c.info_box),l=[],m=b.tile_has(i,"farm",!0),n=b.tile_has(i,"river"),o=b.tile_has(i,"road",!0),p=b.tile_has(i,"dock"),q=b.tile_has(i,"wall",!0),r=b.tile_has(i,"tower",!0),s=_.isObject(i.loot),t=i.population;n&&l.push("River"),m&&l.push("Farms:"+m),p&&l.push("Dock"),q&&l.push("Walls:"+q),r&&l.push("Towers"+r),o&&l.push("Road"),s&&l.push("Loot"),t&&l.push("People: "+t),b.draw_tile(a,f,g,null,null,null,e),_.each(b.entities(a),function(a,b){if(a.x==f&&a.y==g&&a._draw){var d=a._data.side,e=a._data.title||a._data.name||"Unit";e+=" ["+(a._symbol||"@")+"]",$("<span>").addClass("tile_unit_info").css({backgroundColor:d}).text(e).appendTo(c.info_box),a.$trump.css({borderWidth:"3px"
})}else a.$trump.css({borderWidth:"1px"})})}},b.add_unit_ui_to_main_ui=function(a,b){var d=_.str.titleize(b._data.title||b._data.name);b.$trump=$("<div>").text(d).addClass("unit_trump").css({backgroundColor:b._data.side}).appendTo(c.unit_holder)},b.update_unit_ui=function(a,b){var d=_.str.titleize(b._data.title||b._data.name),e="<b>"+d+"</b><hr/>";e+=b.strategy+"<hr/>",b.is_dead&&(e+="<span style='color:red'>Dead on "+battlebox.data.tick_count+"</span><br/>");var f=[];b.fights_won&&f.push(b.fights_won+(b.fights_won>1?" wins":" win")),b.fights_lost&&f.push(b.fights_lost+(b.fights_lost>1?" losses":" loss")),f.length&&(e+=f.join(", ")),_.each(b._data.troops,function(a){var c=_.find(b.forces,function(b){return b.name==a.name})||{},d=c.count||0,f=a.count,g=_.str.titleize(Helpers.pluralize(a.title||a.name));f&&f>d&&(d="<span style='color:red'>"+d+"</span>/"+f),e+="<li>"+d+" "+g+"</li>"}),b.protected_by_walls&&(e+="<b style='color:green'>Protected by wall</b><br/>"),b.in_towers&&(e+="<b style='color:green'>In tower</b><br/>");var g=[];for(var h in b.loot){var i=b.loot[h]+" "+Helpers.pluralize(h);g.push(i)}b.loot&&0==g.length&&b.is_dead?e+="<b>Loot Dropped on death</b>":g.length&&(e+="<b>Loot: "+g.join(", ")+"</b>"),b.$trump.html(e),b.is_dead&&b.$trump.parent()!=c.unit_dead_holder&&(c.unit_dead_holder_title.show(),b.$trump.css({backgroundColor:"lightgray",color:"red"}).appendTo(c.unit_dead_holder))}}(Battlebox),function(a){var b=new a("get_private_functions");b.initialize_data=function(a,b){a.data=a.data||{};var c=a.game_options.arrays_to_map_to_objects||[];_.each(c,function(b){a.data[b]=a.data[b]||{},_.each(a.game_options[b],function(c){a.data[b][c.name]=a.data[b][c.name]||c.initial||0})});var d=a.game_options.arrays_to_map_to_arrays||[];_.each(d,function(b){void 0!==a.data[b]||(a.data[b]=a.data[b]||[],_.each(a.game_options[b],function(c){a.data[b].push(JSON.parse(JSON.stringify(c)))}))}),a.data.rand_seed=a.data.rand_seed||a.game_options.rand_seed,a.data.fight_seed=a.data.fight_seed||a.game_options.fight_seed||a.data.rand_seed,a.data.tick_count=a.data.tick_count||0},b.info=function(a,b,c,d,e){var f=_.find(a.game_options[b],function(a){return a.name==c});return f&&d&&(f=f[d]),f||(f=e),f},b.variable=function(a,b,c){return void 0===c?a.data.variables[b]:void(a.data.variables[b]=c)},b.start_game_loop=function(a){a.logMessage("Starting game loop"),a.data.in_progress=!0,a.engine.start()},b.stop_game_loop=function(a){a.logMessage("Stopping game loop"),a.data.in_progress=!1},b.build_scheduler=function(a){var c=new ROT.Scheduler.Speed;_.each(b.entities(a),function(a){c.add(a,!0)}),a.scheduler=c,a.engine=new ROT.Engine(c)},b.entities=function(a){for(var b=[],c=0;c<a.entities.length;c++)a.entities[c]&&b.push(a.entities[c]);return b}}(Battlebox),function(a){function b(a){console.log("GAME OVER:")}var c={rand_seed:0,tick_time:1e3,game_over_time:600,delay_to_pillage:80,arrays_to_map_to_objects:"".split(","),arrays_to_map_to_arrays:"terrain_options,water_options,forces,buildings".split(","),delay_between_ticks:50,log_level_to_show:4,cols:260,rows:90,cell_size:10,cell_spacing:1,cell_border:0,transpose:!1,render_style:"outdoors",height:"mountainous",sides:[{side:"Yellow",player:!0,plan:"invade city",backup_strategy:"vigilant",face_options:{rand_seed:42,race:"Human"},morale:10,communication_speed:1,try_to_loot:!0,try_to_pillage:!0,goals:{weak_enemies:7,loot:3,all_enemies:4,city:2,friendly_units:2,farm:1,population:1}},{side:"White",home_city:"Anchorage",face_options:{race:"Elf"},plan:"defend city",backup_strategy:"vigilant",morale:15,goals:{weak_enemies:7,towers:6,walls:5,all_enemies:4,city:3}}],terrain_options:[{name:"plains",ground:!0,draw_type:"flat",color:["#d0efc6","#cfefc6","#d1eec6"],symbol:""},{name:"mountains",density:"medium",smoothness:3,not_center:!0,color:["#b1c3c3","#b3c4c4","#8b999c"],impassable:!0,symbol:" "},{name:"forest",density:"sparse",not_center:!0,color:["#85a982","#7B947A","#83A283"],data:{movement:"slow"},symbol:" "}],water_options:[{name:"lake",density:"medium",location:"left",data:{lake:!0}},{name:"lake",density:"large",location:"mid left",data:{lake:!0}},{name:"lake",density:"small",location:"mid right",island:!0,symbol:"~"},{name:"river",density:"small",thickness:1,location:"mid left"},{name:"river",title:"Snake River",density:"medium",thickness:2,location:"center"}],forces:[{name:"Attacker Main Army",side:"Yellow",location:"left",player:!0,troops:{soldiers:520,cavalry:230,siege:50}},{name:"Task Force Alpha",side:"Yellow",symbol:"#A",location:"left",player:!0,leader:{name:"General Vesuvius",face_options:{race:"Demon",age:120}},troops:[{name:"soldiers",count:80,experience:"veteran",victories:12},{name:"cavalry",count:20,experience:"veteran",victories:13},{name:"siege",count:10,experience:"master",victories:23}]},{name:"Task Force Bravo",side:"Yellow",symbol:"#B",location:"left",player:!0,troops:{cavalry:20}},{name:"Task Force Charlie",side:"Yellow",symbol:"#C",location:"left",player:!0,troops:{cavalry:20}},{name:"Task Force Delta",side:"Yellow",symbol:"#D",location:"left",player:!0,troops:{cavalry:20}},{name:"Task Force Echo",side:"Yellow",symbol:"#E",location:"left",player:!0,troops:{cavalry:20}},{name:"Defender City Force",side:"White",location:"city",plan:"seek closest",troops:{soldiers:620,cavalry:40,siege:100}},{name:"Defender Bowmen 1",side:"White",symbol:"1",location:"city",troops:{soldiers:20,siege:20}},{name:"Defender Bowmen 2",side:"White",symbol:"2",location:"city",troops:{soldiers:20,siege:20}},{name:"Defender Bowmen 3",side:"White",symbol:"3",location:"city",troops:{soldiers:20,siege:20}},{name:"Defender Bowmen 4",side:"White",symbol:"4",location:"city",troops:{soldiers:20,siege:20}},{name:"Defender Bowmen 5",side:"White",symbol:"5",location:"city",troops:{soldiers:20,siege:20}},{name:"Defender Bowmen 6",side:"White",symbol:"6",location:"city",troops:{soldiers:20,siege:20}},{name:"Defender Bowmen 7",side:"White",symbol:"7",location:"city",troops:{soldiers:20,siege:20}},{name:"Defender Bowmen 8",side:"White",symbol:"8",location:"city",troops:{soldiers:20,siege:20}},{name:"Defender Catapults",side:"White",symbol:"B",location:"city",troops:{soldiers:20,siege:40}},{name:"Sleeping Dragon",side:"Red",symbol:"}O{",location:"impassable",not_part_of_victory:!0,plan:"wander",backup_strategy:"wait",size:3,move_through_impassable:!0,try_to_loot:!0,try_to_pillage:!0,troops:{adult_dragon:1}}],forces_data:[{name:"soldiers",side:"Yellow",speed:40,strength:1.2,defense:1.8,weapon:"rapier"},{name:"soldiers",side:"White",speed:30,strength:1,defense:2,weapon:"halberds"},{name:"soldiers",side:"all",range:1,vision:5,speed:30,strength:1,defense:2,weapon:"sword",armor:"armor",carrying:5},{name:"cavalry",side:"all",range:1,vision:6,speed:70,initiative:80,strength:1.5,defense:1.5,weapon:"rapier",armor:"shields",carrying:2},{name:"siege",title:"siege units",side:"all",range:2,vision:7,speed:25,ranged_strength:5,strength:.5,defense:.5,weapon:"catapults",carrying:1},{name:"adult_dragon",side:"all",range:2,vision:7,speed:120,strength:150,ranged_strength:50,defense:300,weapon:"fire breath",armor:"impenetrable scales",carrying:2e3}],buildings:[{name:"Large City",title:"Anchorage",type:"city2",location:"center",tightness:1,population:2e4,side:"White",fortifications:[]},{name:"Grain Storage",type:"storage",resources:{food:1e4,gold:2,herbs:100},location:"random"},{name:"Metal Storage",type:"storage",resources:{metal:1e3,gold:2,ore:1e3},location:"random"},{name:"Cave Entrance",type:"dungeon",requires:{mountains:!0},location:"impassable"}],variables:[{name:"test",initial:1}],functions_on_setup:[],functions_each_tick:[],hex_drawing_callbacks:[],game_over_function:b};a.initializeOptions("game_options",c)}(Battlebox),function(a){var b=new a("get_private_functions"),c=!0,d={};d[ROT.VK_Y]=0,d[ROT.VK_NUMPAD7]=0,d[ROT.VK_U]=1,d[ROT.VK_NUMPAD9]=1,d[ROT.VK_L]=2,d[ROT.VK_RIGHT]=2,d[ROT.VK_NUMPAD6]=2,d[ROT.VK_N]=3,d[ROT.VK_NUMPAD3]=3,d[ROT.VK_B]=4,d[ROT.VK_NUMPAD1]=4,d[ROT.VK_H]=5,d[ROT.VK_LEFT]=5,d[ROT.VK_NUMPAD4]=5,d[ROT.VK_K]=0,d[ROT.VK_UP]=0,d[ROT.VK_NUMPAD8]=0,d[ROT.VK_J]=3,d[ROT.VK_DOWN]=3,d[ROT.VK_NUMPAD2]=3,d[ROT.VK_PERIOD]=-1,d[ROT.VK_CLEAR]=-1,d[ROT.VK_NUMPAD5]=-1,b.interpret_command_from_keycode=function(a,b){var e={movement:null,func:null,ignore:!1},f=a;if((13==f||32==f)&&b.execute_action)return e.func=b.execute_action,e;if(!(f in d))return e.ignore=!0,e;if(f=d[f],-1==f)return e.ignore=!0,e;c=!c,a==ROT.VK_UP&&c?f=1:a!=ROT.VK_UP||c?a==ROT.VK_DOWN&&c?f=3:a!=ROT.VK_DOWN||c||(f=4):f=0;var g=ROT.DIRS[6][f];return g&&(e.movement=g),e}}(Battlebox),function(a){function b(a){var b=document.cookie.match(new RegExp(a+"=([^;]+)"));return b&&(b=JSON.parse(b[1])),b}function c(a,b){var c=new Date;c.setDate(c.getDate()+30);var d=[a,"=",JSON.stringify(b),"; expires=.",c.toUTCString(),"; domain=.",window.location.host.toString(),"; path=/;"].join("");document.cookie=d}var d=new a("get_private_functions"),e="battlebox_1";d.autosave_if_time=function(a){a.game_options.autosave&&(a.data.autosave_counter=a.data.autosave_counter||0,a.data.autosave_counter+=1,a.data.autosave_counter>=a.game_options.autosave_every&&(d.save(a,"auto"),a.data.autosave_counter=0))},d.load=function(a,c){var f,g=!1;if("cookie"==c){if(f=b(e),!f)return console.info("Unable to find cookie"),!1;a.logMessage("Loaded saved game from cookie. Save system switching to localStorage.")}else if("localStorage"==c){var h;try{h=localStorage.getItem(e),h&&(f=JSON.parse(h))}catch(i){console.info("Cannot access localStorage - browser may not support localStorage, or storage may be corrupt")}if(!f)return console.info("Unable to find variables in localStorage. Attempting to load cookie."),d.load(a,"cookie"),!1;a.logMessage("Loaded saved game from localStorage")}else if("import"==c){var j=document.getElementById("impexpField").value,k=LZString.decompressFromBase64(j);f=JSON.parse(k),a.logMessage("Imported saved game")}return f&&f.rand_seed&&f.variables&&f.resources&&void 0!==f.resources.food?(a.data=f,g=!0,d.initialize_ui_display(a),d.update_ui_display(a)):a.logMessage("No valid saved game data available, starting with defaults"),g},d.save=function(a,d){c(e,a.data);try{localStorage.setItem(e,JSON.stringify(a.data))}catch(f){a.logMessage("Cannot access localStorage to save game - browser may be old or storage may be corrupt")}if("export"==d){var g=JSON.stringify(a.data),h=LZString.compressToBase64(g);console.log("Compressed Save from "+g.length+" to "+h.length+" characters"),document.getElementById("impexpField").value=h,a.logMessage("Saved game and exported to base64",!0)}(b(e)||localStorage.getItem(e))&&("auto"==d?a.logMessage("Autosaved",!1):"manual"==d&&a.logMessage("Saved game manually",!0))},d.toggleAutosave=function(a,b){},d.deleteSave=function(a){c(e,""),localStorage.setItem(e,"")},d.reset=function(a){}}(Battlebox),function(a){function b(a,b,c){var d=a.display._backend;return{x:(b+1)*d._spacingX,y:c*d._spacingY+d._hexSize}}function c(a,b,c){var d=a.display._backend,e=d._context.canvas.height/d._options.height;return c=Math.floor(c/e),c.mod(2)?(b-=d._spacingX,b=1+2*Math.floor(b/(2*d._spacingX))):b=2*Math.floor(b/(2*d._spacingX)),{x:b,y:c}}function d(a,b,c,d,e){var f,g,h,i,j,k={x:null,y:null,onLine1:!1,onLine2:!1};return f=(d.y-c.y)*(b.x-a.x)-(d.x-c.x)*(b.y-a.y),0==f?k:(g=a.y-c.y,h=a.x-c.x,i=(d.x-c.x)*g-(d.y-c.y)*h,j=(b.x-a.x)*g-(b.y-a.y)*h,g=i/f,h=j/f,k.x=a.x+g*(b.x-a.x),k.y=a.y+g*(b.y-a.y),g>0&&1>g&&(k.onLine1=!0),h>0&&1>h&&(k.onLine2=!0),e&&(k.crossed=e),k)}function e(a,b,e,f,g,h,k){for(var l=[],m=[],n=0;b>n;n++){var o=(n/b+(f||0))%1;o*=2*Math.PI;var p=h.x+k*Math.cos(o),q=h.y+k*Math.sin(o);l.push({x:p,y:q})}for(var r=1.5,n=0;e>n;n++){var o=(n/e+(f||0))%1;o*=2*Math.PI;for(var s={x:h.x+k*r*Math.cos(o),y:h.y+k*r*Math.sin(o)},t=0;t<l.length;t++){var u=l[t],v=l[(t+1)%l.length],w=d(h,s,u,v);if(w.onLine1&&w.onLine2){var x=c(a,w.x,w.y);m.push(i.tile(a,x.x,x.y))}}j.push({p1:h,p2:s})}return m}function f(a,b){ROT.RNG.setSeed(a.data.rand_seed+(b||0))}function g(a,b,c){c=c||10;for(var d=0;d<a.length&&!(a[d]==b&&(a.splice(d,1),d--,c--,0>=c));d++);return a}function h(a){a.color&&_.isArray(a.color)&&(a.color=a.color.random())}var i=new a("get_private_functions"),j=[];i.tile=function(a,b,c){var d;if(!a.cells)throw"Game Cells don't seem to exist, something went wrong with generating the map.";return void 0===c?(d=a.cells[b[0]],d&&(d=d[b[1]])):(d=a.cells[b],d&&(d=d[c])),d},i.tile_info=function(a,b,c){var d={},e=i.tile(a,b,c);return e&&(d=_.clone(e),_.each(i.entities(a),function(a,e){a.x==b&&a.y==c&&a._draw&&(d.forces=d.forces||[],d.forces.push({id:e,data:a.forces}))})),d},i.surrounding_tiles=function(a,b,c,d){function e(b,c){var d=i.tile(a,b,c);d&&d&&f.push(d)}var f=[];d=d||1;for(var g=b,h=c,j=1;d>=j;++j){g+=2,e(g,h);for(var k=0;j-1>k;++k)e(++g,++h);for(var k=0;j>k;++k)e(--g,++h);for(var k=0;j>k;++k)g-=2,e(g,h);for(var k=0;j>k;++k)e(--g,--h);for(var k=0;j>k;++k)e(++g,--h);for(var k=0;j>k;++k)g+=2,e(g,h)}return f},i.tile_is_traversable=function(a,b,c,d,e){var f=b>=0&&c>=0&&b<i.cols(a)&&c<i.rows(a);if(f){var g=i.tile(a,b,c);g?(!d&&g.impassable&&(f=!1),e&&(f=g.impassable)):f=!1}return f},i.find_tile_by_filters=function(a,b){var c=b.vision||b.range||3,d=null,e=b.location;_.isString(e)&&(e=i.find_a_matching_tile(a,b));i.surrounding_tiles(a,e.x,e.y,c);return d},i.find_a_matching_tile=function(a,b){var c,d,e,f,g=Math.round(.25*i.cols(a)),h=Math.round(.75*i.cols(a)),j=Math.round(.5*i.cols(a)),k=Math.round(.25*i.rows(a)),l=Math.round(.75*i.rows(a)),m=Math.round(.5*i.rows(a)),n=[g-4,g-3,g-2,g-1,g,g+1,g+2,g+3,g+4],o=[j-4,j-3,j-2,j-1,j,j+1,j+2,j+3,j+4],p=[h-4,h-3,h-2,h-1,h,h+1,h+2,h+3,h+4],q=[l-4,l-3,l-2,l-1,l,l+1,l+2,l+3,l+4],r=[m-4,m-3,m-2,m-1,m,m+1,m+2,m+3,m+4],s=[k-4,k-3,k-2,k-1,k,k+1,k+2,k+3,k+4],t=50,u=0;if("center"==b.location)for(e=0;t>e&&(c=b.x||i.cols(a)/2+i.randInt(i.cols(a)/6)-i.cols(a)/12-1,d=b.y||i.rows(a)/2+i.randInt(i.rows(a)/6)-i.rows(a)/12-1,c=Math.floor(c),d=Math.floor(d),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);else{if(_.isObject(b.location))return b.location;if("city"==b.location){var v=_.filter(a.data.buildings,function(a){return"city"==a.type||"city2"==a.type}),w=i.randOption(v);if(w&&w.tiles){var x=i.randOption(w.tiles);c=x.x,d=x.y}}else if("left"==b.location)for(e=0;t>e&&(c=b.x||i.randOption([0,1,2]),d=b.y?i.randOption([b.y-1,b.x-2,b.x-3]):i.randInt(i.rows(a)),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);else if("right"==b.location){var y=i.cols(a);for(e=0;t>e&&(c=b.x||i.randOption([y-1,y-2,y-3]),d=b.y?i.randOption([b.y-1,b.x-2,b.x-3]):i.randInt(i.rows(a)),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);}else if("mid left"==b.location)for(e=0;t>e&&(c=b.x||i.randOption(n),d=b.y||i.randInt(i.rows(a)),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);else if("mid right"==b.location)for(e=0;t>e&&(c=b.x||i.randOption(p),d=b.y||i.randInt(i.rows(a)),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);else if("mid top"==b.location)for(e=0;t>e&&(c=b.x||i.randInt(i.cols(a)),d=b.y||i.randOption(s),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);else if("mid bottom"==b.location)for(e=0;t>e&&(c=b.x||i.randInt(i.cols(a)),d=b.y||i.randOption(q),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);else if("w"==b.location)for(e=0;t>e&&(c=b.x||i.randOption(n),d=b.y||i.randOption(r),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);else if("s"==b.location)for(e=0;t>e&&(c=b.x||i.randOption(o),d=b.y||i.randOption(q),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);else if("n"==b.location)for(e=0;t>e&&(c=b.x||i.randOption(o),d=b.y||i.randOption(s),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);else if("e"==b.location)for(e=0;t>e&&(c=b.x||i.randOption(p),d=b.y||i.randOption(r),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);else if("sw"==b.location)for(e=0;t>e&&(c=b.x||i.randOption(n),d=b.y||i.randOption(q),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);else if("se"==b.location)for(e=0;t>e&&(c=b.x||i.randOption(p),d=b.y||i.randOption(q),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);else if("nw"==b.location)for(e=0;t>e&&(c=b.x||i.randOption(n),d=b.y||i.randOption(s),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);else if("ne"==b.location)for(e=0;t>e&&(c=b.x||i.randOption(p),d=b.y||i.randOption(s),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);else if("top"==b.location)for(e=0;t>e&&(c=b.x?i.randOption([b.x-2,b.x-1,b.x,b.x+1,b.x+2]):i.randInt(i.cols(a)),d=i.randOption([0,1]),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);else if("bottom"==b.location){var z=i.rows(a);for(e=0;t>e&&(c=b.x?i.randOption([b.x-2,b.x-1,b.x,b.x+1,b.x+2]):i.randInt(i.cols(a)),d=i.randOption([z-1,z-2]),!i.tile_is_traversable(a,c,d,b.move_through_impassable));e++);}else if("impassable"==b.location)for(e=0;t>e&&(d=b.x||i.randInt(i.rows(a)),c=b.y||d%2+2*i.randInt(i.cols(a)/2),!i.tile_is_traversable(a,c,d,!0,!0));e++);else if(b.location)for(e=0;t>e&&(d=b.x||i.randInt(i.rows(a)),c=b.y||d%2+2*i.randInt(i.cols(a)/2),!i.tile_is_traversable(a,c,d)||!i.tile_has(i.tile(a,c,d),b.location));e++);else u=Math.floor(ROT.RNG.getUniform()*a.open_space.length),f=a.open_space[u],c=parseInt(f[0]),d=parseInt(f[1])}return i.tile_is_traversable(a,c,d,!0)||(u=Math.floor(ROT.RNG.getUniform()*a.open_space.length),f=a.open_space[u],c=parseInt(f[0]),d=parseInt(f[1])),a.open_space.length&&void 0!==c&&void 0!==d||(console.error("No open spaces, can't find valid cell"),c=0,d=a.randInt(i.rows(gmae),a.game_options)),{x:c,y:d}},i.tile_has=function(a,b,c){var d=0;if(a&&a.additions)for(var e=0;e<a.additions.length;e++){var f=a.additions[e];if(f==b||f&&f.name&&f.name==b){if(!c){d=f;break}d++}}return d};var k=[{angle:330,rot_number:0,road_symbol:"╲",description:"North West",abbr:"NW"},{angle:30,rot_number:1,road_symbol:"╱",description:"North East",abbr:"NE"},{angle:90,rot_number:2,road_symbol:"━",description:"East",abbr:"E"},{angle:150,rot_number:3,road_symbol:"╲",description:"South East",abbr:"SE"},{angle:210,rot_number:4,road_symbol:"╱",description:"South West",abbr:"SW"},{angle:270,rot_number:5,road_symbol:"━",description:"West",abbr:"W"}];i.direction_from_tile_to_tile=function(a,b){var c=Math.atan2(b.y-a.y,b.x-a.x);c+=.5*Math.PI,c=(c+2*Math.PI)%(2*Math.PI);var d=c/(2*Math.PI/6),e=Math.ceil(d)%6,f=k[e];return f.hex_dir_change_array=ROT.DIRS[6][f.rot_number],f},i.opposite_tiles_from_tile_to_tile=function(a,b,c){var d=[],e=Math.atan2(c.y-b.y,c.x-b.x);e+=.5*Math.PI,e=(e+2*Math.PI)%(2*Math.PI);for(var f=e/(2*Math.PI/6),g=Math.ceil(f+5)%6,h=Math.ceil(f)%6,j=Math.ceil(f+1)%6,k=0;6>k;k++)if(g!=k&&h!=k&&j!=k){var l=ROT.DIRS[6][k],m=i.tile(a,c.x+l[0],c.y+l[1]);d.push(m)}return d},i.generate_base_map=function(a){a.data.terrain_options=a.data.terrain_options||[],0==a.data.terrain_options.length&&(a.data.terrain_options=[{name:"plains",layer:"ground"}]);for(var b=[],c=0;c<i.rows(a);c++)for(var d=c%2;d<i.cols(a);d+=2)b[d]=b[d]||[],b[d][c]={};_.each(a.data.terrain_options,function(c){b=i.generators.terrain_layer(a,c,b)});for(var e=[],f=_.find(a.data.terrain_options,function(a){return a.ground})||a.data.terrain_options[0],c=0;c<i.rows(a);c++)for(var d=c%2;d<i.cols(a);d+=2)b[d][c]&&b[d][c].impassable||(e.push([d,c]),b[d][c].name||(b[d][c]=_.clone(f),h(b[d][c]),b[d][c].x=d,b[d][c].y=c));a.open_space=e,a.cells=b},i.generate_water_layers=function(a){_.each(a.data.water_options,function(b){var c=i.find_a_matching_tile(a,b);"river"==b.name?i.generators.river(a,b,c):"lake"==b.name?i.generators.lake(a,b,c):"sea"==b.name&&i.generators.sea(a,b,c),b.location=c})},i.generate_buildings=function(a){_.each(a.data.buildings,function(b,c){f(a,c);var d=i.find_a_matching_tile(a,b);if("city"==b.type?b.tiles=i.generators.city(a,d,b):"city2"==b.type?b.tiles=i.generators.city2(a,d,b):"storage"==b.type?i.generators.storage(a,d,b):"dungeon"==b.type,b.location=d,b.fortifications){var e=b.fortifications;_.isArray(e)||(e=[e]),_.each(e,function(c){var e=_.str.titleize(b.title||b.name)+"s walls",f={count:c.count||(b.population||0)/1e4,title:c.title||e,shape:c.shape,radius:c.radius,towers:c.towers,side:b.side,starting_angle:c.starting_angle};i.generators.walls(a,d,f)})}})},i.population_counter=function(a,b){var c=0;return b&&b.length?_.each(b,function(b){b&&(c+=a.cells[b.x][b.y].population||0)}):_.each(a.cells,function(a){_.each(a,function(a){a&&(c+=a.population||0)})}),c},i.testAddRandomLines=function(a,b){a.strokeStyle=b||"blue";for(var c=0;c<j.length;c++){var d=j[c];a.beginPath(),a.moveTo(d.p1.x,d.p1.y),a.lineTo(d.p2.x,d.p2.y),a.closePath(),a.stroke()}return a},i.shape_to_tiles=function(a,d,f,g,h,j){var k=[],l=b(a,d.x,d.y),m=Helpers.distanceXY(l,b(a,d.x-2*h,d.y));if("circle"==f)for(var n=0;g>n;n++){var o=n/g+(j||0);o*=2*Math.PI;var p=l.x+m*Math.cos(o),q=l.y+m*Math.sin(o),r=c(a,p,q);i.tile_is_traversable(a,r.x,r.y)&&k.push(i.tile(a,r.x,r.y))}else if("square"==f)k=e(a,4,g,j,d,l,m);else if("pentagon"==f)k=e(a,5,g,j,d,l,m);else if("hexagon"==f)k=e(a,6,g,j,d,l,m);else if("septagon"==f)k=e(a,7,g,j,d,l,m);else if("octagon"==f)k=e(a,8,g,j,d,l,m);else if("rounded square"==f)for(var n=0;g>n;n++){var o=n/g+(j||0);o*=2*Math.PI;var s=Math.cos(o),t=Math.sin(o);s=(0>s?-1:1)*Math.pow(Math.abs(s),.5),t=(0>t?-1:1)*Math.pow(Math.abs(t),.5);var p=l.x+m*s,q=l.y+m*t,r=c(a,p,q);i.tile_is_traversable(a,r.x,r.y)&&k.push(i.tile(a,r.x,r.y))}else if("diamond"==f)for(var n=0;g>n;n++){var o=n/g+(j||0);o*=2*Math.PI;var s=Math.cos(o),t=Math.sin(o);s=(0>s?-1:1)*Math.abs(Math.pow(s,3)),t=(0>t?-1:1)*Math.abs(Math.pow(t,3));var p=l.x+m*s,q=l.y+m*t,r=c(a,p,q);i.tile_is_traversable(a,r.x,r.y)&&k.push(i.tile(a,r.x,r.y))}else if("flower"==f)for(var n=0;g>n;n++){var o=n/g+(j||0);o*=2*Math.PI;var s=Math.cos(o),t=Math.sin(o);s=(0>s?-1:1)*Math.abs(Math.pow(s,4)),t=(0>t?-1:1)*Math.abs(Math.pow(t,4));var p=l.x+m*s,q=l.y+m*t,r=c(a,p,q);i.tile_is_traversable(a,r.x,r.y)&&k.push(i.tile(a,r.x,r.y))}return k},i.generators={},i.generators.walls=function(a,b,c){var d=i.shape_to_tiles(a,b,c.shape||"circle",c.count,c.radius||4,c.starting_angle),e=-1;_.each(d,function(a,b){if(a&&!a.impassable){a.additions=a.additions||[],a.additions.push("wall"),a.side=c.side;var d=Math.round(b*((c.towers||0)/c.count));d>e&&(a.additions.push("tower"),e=d)}})},i.generators.city2=function(a,b,c){var d,e=3.1*(c.tightness||1),h=[],j=null,k=_.filter(a.data.buildings,function(a){return"city"==a.type||"city2"==a.type});k.length>1&&_.indexOf(k,c)>0&&k[0].tiles?(j=k[0].tiles[0],d=1):d=void 0!==c.road_count?c.road_count:Math.pow(c.population/100,.25);var l=c.road_tiles||i.generators.roads_from(a,d,b,j);l.sort(function(a,c){var d=Helpers.distanceXY(b,a),e=Helpers.distanceXY(b,c);return d>e}),c.road_tiles=l,f(a);var m=i.tile(a,b.x,b.y),n=Math.floor(Math.sqrt(c.population));m.type="city",m.name=c.name,m.title=c.title,m.side=c.side,a.cells[m.x][m.y]=m,m.population=m.population||0,m.population+=2*n,h.push(m);for(var o=[],p=0;n>p;p++){var q=[i.randHistogram(.05,2*e),ROT.RNG.getNormal(),ROT.RNG.getNormal(),ROT.RNG.getNormal()];o.push(q)}if(l.length)for(var p=0;n>p;p++){var r=Math.round(o[p][0]*l.length),s=l[r],t=i.surrounding_tiles(a,s.x,s.y,2);t=_.filter(t,function(a){return!i.tile_has(a,"road")&&!i.tile_has(a,"river")&&"lake"!=a.name}),_.each(t,function(a){a.population=a.population||0,a.population+=n/(3*t.length),-1==_.indexOf(h,a)&&h.push(a)})}for(var u=Math.pow(c.population,1/e),v=1.5*u,p=0;n>p;p++){var w,x;w=b.x+o[p][1]*v/4,x=b.y+o[p][2]*u/4,w=Math.floor(w),x=Math.floor(x);var y=i.tile(a,w,x);if(y&&i.tile_is_traversable(a,w,x,!1)&&!i.tile_has(y,"road")&&!i.tile_has(y,"river")&&"lake"!=y.name){y.population=y.population||0,y.population+=n/4+o[p][3]*v,y.population=Math.ceil(Math.max(0,y.population)),y.side=c.side,a.cells[w][x]=y,-1==_.indexOf(h,y)&&h.push(y);var z=i.surrounding_tiles(a,w,x,1);z=_.filter(z,function(a){return!i.tile_has(a,"road")&&!i.tile_has(a,"river")&&"lake"!=a.name}),_.each(z,function(b){b.population=b.population||0,b.population+=n/(1.8*t.length),b.population=Math.ceil(Math.max(0,b.population)),b.side=c.side,a.cells[b.x][b.y]=b,-1==_.indexOf(h,b)&&h.push(b)})}}for(var A=[h[0]],p=0;p<h.length;p++){var y=h[p];w=y.x,x=y.y;var B=Math.round(y.population);if(B>=70){a.cells[w][x]={name:c.name,title:c.title,population:B,type:"city",side:c.side,x:w,y:x},y.population=B;var z=i.surrounding_tiles(a,w,x);_.each(z,function(a){a.additions=a.additions||[],"city"!=a.type&&("mountains"==a.name?a.additions.push("mine"):"lake"==a.name||i.tile_has(a,"river")?a.additions.push("dock"):a.additions.push("farm"))}),-1==_.indexOf(A,y)&&A.push(y)}else y.population=B,a.cells[w][x].population=B,a.cells[w][x].side=c.side}var C=c.population-i.population_counter(a,h);C>0&&(h[0].population+=Math.round(C));for(var D=10,E=0;D>E;E++)for(var F=h.length,p=0;F>p;p++){var y=h[p],G=i.tile_has(y,"farm",!0);if(G>5||y.population>100){y.additions=y.additions||[];var z=i.surrounding_tiles(a,y.x,y.y),H=Math.floor(G/z.length),I=(y.population-100)/(z.length+1);_.each(z,function(b){b.additions=b.additions||[];for(var d=0;H>d;d++)b.additions.push("farm");b.population=b.population||0,b.population+=Math.round(I),b.side=c.side,a.cells[b.x][b.y]=b,-1==_.indexOf(h,b)&&h.push(b)}),y.additions=g(y.additions,"farm",z.length*H),y.population-=Math.round(I*z.length),y.side=c.side,a.cells[y.x][y.y]=y}}return A},i.generators.terrain_layer=function(a,b,c){var d;if("digger"==b.draw_type)d=new ROT.Map.Digger(i.cols(a),i.rows(a));else if("flat"!=b.draw_type){var e=[5,6,7],f=[3,4,5];if("small"==b.density?(e=[4],f=[3]):"sparse"==b.density?(e=[4,5],f=[3,4]):"medium"==b.density?(e=[4,5],f=[4,5,6]):"high"==b.density&&(e=[4,5,6,7],f=[3,4,5,6]),d=new ROT.Map.Cellular(i.cols(a),i.rows(a),{topology:6,born:e,survive:f}),b.not_center)for(var g=0;g<i.cols(a);g++)for(var j=0;j<i.rows(a);j++){var k=g/i.cols(a)-.5,l=j/i.rows(a)-.5,m=Math.pow(k*k+l*l,.3);ROT.RNG.getUniform()<m&&d.set(g,j,1)}else d.randomize(b.thickness||.5);for(var n=b.smoothness||3,g=n-1;g>=0;g--)d.create(g?null:a.display.DEBUG)}if(d&&d.create){var o=function(a,d,e){e&&(c[a]=c[a]||[],c[a][d]=_.clone(b),h(c[a][d]),c[a][d].x=a,c[a][d].y=d)};d.create(o.bind(a))}return c},i.generators.storage=function(a,b,c){var d=2,e={};c.resources=c.resources||{};for(key in c.resources)e[key]=Math.round(c.resources[key]/(d*d));for(var f=b.x;f<=b.x+d;f++)for(var g=b.y;g<b.y+d;g++){var h=i.tile(a,f,g);if(h){h.loot=h.loot||{};for(key in e)h.loot[key]=h.loot[key]||0,h.loot[key]+=e[key];h.additions=h.additions||[],h.additions.push("storage")}}},i.generators.roads_from=function(a,b,c,d){for(var e=20,f="",g=[],h=0;b>h;h++){var j=i.randOption(["left","right","top","bottom"],{},f);f=j;for(var k=0;e>k;k++){d=d||i.find_a_matching_tile(a,{location:j});var l=i.path_from_to(a,c.x,c.y,d.x,d.y);if(d=null,l&&l.length){for(var m=1;m<l.length;m++){var n=i.tile(a,l[m]),o=i.tile(a,l[m-1]),p=i.direction_from_tile_to_tile(o,n);n&&(n.additions=n.additions||[],n.additions.push({name:"road",symbol:p.road_symbol}),g.push(n))}break}}}return g},i.generators.lake=function(a,b,c){function d(c,f,g){if(i.tile_is_traversable(a,c,f,!1)){var j=a.cells[c][f].data&&a.cells[c][f].data.water;if(j);else{var k=_.clone(b);if(k.data=k.data||{},k.data.water=!0,k.data.depth=g,k.x=c,k.y=f,h(k),a.cells[c][f]=k,e.push(k),g>1){var l=i.surrounding_tiles(a,c,f);_.each(l,function(a){d(a.x,a.y,g-1)})}}}}var e=[],f=30;"small"==b.density?f=7:"medium"==b.density?f=30:"large"==b.density?f=60:_.isNumber(b.density)&&(f=parseInt(b.density));for(var g=Math.pow(f,1/1.45),j=1.5*g,k=0;f>k;k++){var l,m;l=c.x+i.randInt(j)-j/2-1,m=c.y+i.randInt(g)-g/2-1,l=Math.floor(l),m=Math.floor(m),d(l,m,3)}return e},i.generators.river=function(a,b,c){for(var d=[],e=20,f=0;e>f;f++){var g,j,k="top";"left"==k?(j=i.find_a_matching_tile(a,{location:"left",y:c.y}),g=i.find_a_matching_tile(a,{location:"right",y:c.y})):(j=i.find_a_matching_tile(a,{location:"top",x:c.x}),g=i.find_a_matching_tile(a,{location:"bottom",x:c.x}));var l=i.path_from_to(a,j.x,j.y,g.x,g.y);if(l&&l.length){for(var m=1;m<l.length;m++)for(var n=0;n<(b.thickness||1);n++){var o=l[m][1],p=l[m][0];"left"==k&&n?o+=n:"top"==k&&n&&(p+=2*n);var q=i.tile(a,p,o);if(i.tile_is_traversable(a,p,o)){var r,s=i.tile(a,l[m-1]);r=0==n?i.direction_from_tile_to_tile(s,q)||{road_symbol:""}:i.direction_from_tile_to_tile(s,i.tile(a,l[m]))||{road_symbol:""};var t=_.clone(b.data||{});t.name="river",t.x=p,t.y=o,t.water=!0,t.depth=b.thickness||1,t.symbol=r.road_symbol,t.title=b.title||b.name,q.additions=q.additions||[],q.additions.push(t),h(q)}}break}}return d},i.generators.sea=function(a,b,c){var d=[];return d},i.generators.city=function(a,b,c){var d=Math.sqrt(c.population),e=Math.pow(c.population,.3125),f=1.5*e,g=c.road_count||Math.pow(c.population/100,.25),h=[];i.generators.roads_from(a,g,b);ROT.RNG.setSeed(a.data.fight_seed||a.data.rand_seed);for(var j=0;d>j;j++){var k,l;if(k=b.x+i.randInt(f)-f/2-1,l=b.y+i.randInt(e)-e/2-1,k=Math.floor(k),l=Math.floor(l),i.tile_is_traversable(a,k,l,!1)){a.cells[k][l]=_.clone(c),a.cells[k][l].x=k,a.cells[k][l].y=l,h.push(a.cells[k][l]);var m=i.surrounding_tiles(a,k,l);_.each(m,function(a){a.additions=a.additions||[],"city"!=a.type&&("mountains"==a.name?a.additions.push("mine"):"lake"==a.name?a.additions.push("dock"):a.additions.push("farm"),h[a.x]&&h[a.x][a.y]||h.push(a))})}}return h}}(Battlebox),function(a){function b(a,b,d){return"vigilant"==d.backup_strategy?c.movement_strategies.vigilant(a,b):"wait"==d.backup_strategy?c.movement_strategies.wait(a,b):c.movement_strategies.wander(a,b)}var c=new a("get_private_functions");c.tile_traversability_weight=function(a,b,d){var e=c.tile(a,b,d),f=0;return"plains"==e.name&&(f+=4),"mountains"==e.name&&(f+=12),"forest"==e.name&&(f+=6),"medium"==e.density&&(f+=4),"large"==e.density&&(f+=8),"lake"==e.name&&(f+=8),c.tile_has(e,"path")&&(f-=2),c.tile_has(e,"road")&&(f-=4),c.tile_has(e,"rail")&&(f-=8),c.tile_has(e,"river")&&(f+=4),Math.max(0,f)},c.path_from_to=function(a,b,d,e,f){var g=function(b,c){var d=a.cells[b];return d=void 0!==d?d[c]:null,d&&!d.impassable},h=new ROT.Path.AStar(e,f,g,{topology:6}),i=[],j=function(a,b){i.push([a,b])},k=function(b,d){return c.tile_traversability_weight(a,b,d)};return h.compute(b,d,j,k),i},c.find_unit_by_filters=function(a,b,d){var e=c.entities(a);d.range&&(e=_.filter(e,function(a){return Helpers.distanceXY(b,a)<d.range})),d.only_count_forces&&(e=_.filter(e,function(a){return!a._data.not_part_of_victory})),d.location&&(e=_.filter(e,function(a){return a.x==d.location.x&&a.y==d.location.y})),d.side&&(e=_.filter(e,function(a){return"enemy"==d.side?b._data.side!=a._data.side:b._data.side==a._data.side})),d.filter&&"closest"==d.filter&&(e=e.sort(function(d,e){var f=c.path_from_to(a,b.x,b.y,d.x,d.y),g=c.path_from_to(a,b.x,b.y,e.x,e.y),h=f?f.length:100,i=g?g.length:100;return h>i}));var f,g,h,i,j;return d.return_multiple?e.length?(h=c.path_from_to(a,b.x,b.y,e[0].x,e[0].y),g=h.length||0,e[0].getX&&(i=e[0].getX()),e[0].getY&&(j=e[0].getY()),f=e):(f=[],i=0,j=0,g=0):(f=e[0],f&&(h=c.path_from_to(a,b.x,b.y,f.x,f.y),g=h.length||0,f.getX&&(i=f.getX()),f.getY&&(j=f.getY()))),{target:f,x:i,y:j,range:g}},c.movement_strategies=c.movement_strategies||{},c.movement_strategies.vigilant=function(a,b){c.log_message_to_user(a,b.describe()+" stays vigilant and doesn't move",1)},c.movement_strategies.wander=function(a,b){var d=Helpers.randOption([0,1,2,3,4,5]),e=ROT.DIRS[6][d],f=b.y+e[1],g=b.x+e[0];b.strategy="Wander";var h=b.describe()+" ",i=b.try_to_move_to_and_draw(g,f);i?c.log_message_to_user(a,h+"wanders a space",1):c.movement_strategies.wait(a,b)},c.movement_strategies.wait=function(a,b){b.strategy="Wait for enemy to be near",c.log_message_to_user(a,b.describe()+" stays vigilant and doesn't move",0)},c.movement_strategies.seek=function(a,d,e,f){var g=void 0!==e.x?e.x:e.target?e.target.getX():-1,h=void 0!==e.y?e.y:e.target?e.target.getY():-1,i="";if(i=e.target?e.target.describe():g+", "+h,d.strategy="Seek target",!c.tile_is_traversable(a,g,h))return b(a,d,f);
var j=c.path_from_to(a,d.x,d.y,g,h);if(f.range&&j&&j.length>f.range||!j||j&&0==j.length)return b(a,d,f);if(j.shift(),j.length<=1&&e.target){var k=c.entity_attacks_entity(a,d,e.target,c.log_message_to_user);k&&d.try_to_move_to_and_draw(e.target.x,e.target.y)}else{if(!j.length)return b(a,d,f);g=j[0][0],h=j[0][1];var k=d.try_to_move_to_and_draw(g,h);if(!k)return b(a,d,f);c.log_message_to_user(a,d.describe()+" moves towards their target: "+i,1)}},c.movement_strategies.head_towards_2=function(a,d,e,f){var g;d.strategy="Head to "+e.location.x+", "+e.location.y;var h=!1;if(f.stop_if_cell_has){var i=c.tile(a,d.x,d.y);if(i){if(_.each(f.stop_if_cell_has,function(a){c.tile_has(i,a)&&(h=!0)}),h)return b(a,d,f)}else console.error("unit "+d._data.name+" is at invalid loc: "+d.x+", "+d.y)}var j=e&&e.location&&void 0!==e.location.x&&void 0!==e.location.y,k={side:"enemy",filter:"closest",range:d.vision||d.range||3,plan:"seek closest",backup_strategy:d._data.backup_strategy},l=c.find_unit_by_filters(a,d,k);if(!j||l&&l.target)return c.movement_strategies.seek(a,d,l,f);g=c.path_from_to(a,d.x,d.y,e.location.x,e.location.y),g.shift();var m=!1;if(g.length){var n=g[0][0],o=g[0][1];m=d.try_to_move_to_and_draw(n,o),m&&d.waypoint&&d.waypoint.x==n&&d.waypoint.y==o&&(d.waypoint=null,d.waypoint_weight=null)}else f.when_arrive&&(d._data.plan=f.when_arrive,m=!0);return m?void c.log_message_to_user(a,d.describe()+" moves towards their target: "+(e.title||e.name),1):b(a,d,f)},c.movement_strategies.head_towards=function(a,d,e,f){var g;d.strategy="Head to "+e.location.x+", "+e.location.y;var h=!1;if(f.stop_if_cell_has){var i=c.tile(a,d.x,d.y);if(i){if(_.each(f.stop_if_cell_has,function(a){c.tile_has(i,a)&&(h=!0)}),h)return b(a,d,f)}else console.error("unit "+d._data.name+" is at invalid loc: "+d.x+", "+d.y)}var j=e&&e.location&&void 0!==e.location.x&&void 0!==e.location.y;if(!j)return f={side:"enemy",filter:"closest",range:d.vision||d.range||3,plan:"seek closest",backup_strategy:d._data.backup_strategy},l=c.find_unit_by_filters(a,d,f),void c.movement_strategies.seek(a,d,l,f);g=c.path_from_to(a,d.x,d.y,e.location.x,e.location.y),g.shift();var k=!1;if(g.length<=(d.vision||d.range||3)){if(!f.when_arrive){f={side:"enemy",filter:"closest",range:d.vision||d.range||3,plan:"invade city",backup_strategy:d._data.backup_strategy};var l=c.find_unit_by_filters(a,d,f);return l&&l.target?c.movement_strategies.seek(a,d,l,f):b(a,d,f)}d._data.plan=f.when_arrive,k=!0}else if(g.length){var m=g[0][0],n=g[0][1];k=d.try_to_move_to_and_draw(m,n)}return k?void c.log_message_to_user(a,d.describe()+" moves towards their target: "+(e.title||e.name),1):b(a,d,f)},c.movement_strategies.avoid=function(a,d,e,f){var g=e.target?e.target.getX():-1,h=e.target?e.target.getY():-1;if(d.strategy="Avoiding enemy",!c.tile_is_traversable(a,g,h))return b(a,d,f);var i=c.path_from_to(a,d.x,d.y,g,h),j=!1;return f.range&&i&&i.length<=f.range&&(i.shift(),i.length>0&&(g=i[0][0],h=i[0][1],g=d.x-g,h=d.y-h,g=d.x+g,h=d.y+h,j=d.try_to_move_to_and_draw(g,h))),j?void 0:b(a,d,f)}}(Battlebox),function(a){var b=new a("get_private_functions"),c=0;b.build_units_from_list=function(a,c){return _.each(c||[],function(c,d){var e=b.create_unit(a,c,d);a.entities.push(e),b.add_unit_ui_to_main_ui(a,e)}),b.entities(a)},b.add_screen_scheduler=function(a){a.scheduler.add(new d(a),!0)},b.create_unit=function(a,c,d){var e,h=b.find_a_matching_tile(a,c);e=c.player?f:g;var i=c.side||"Neutral",j=_.find(a.game_options.sides,function(a){return a.side==i})||{},k=$.extend({},j,c),l=new e(a,h.x,h.y,d,k);if(!l.data_expanded){if(l.forces=[],_.isArray(l._data.troops))_.each(l._data.troops,function(c){var d=b.hydrate_troop_metadata(a,c,c.count,l._data.side);l.forces.push(d)});else if(_.isObject(l._data.troops))for(var m in l._data.troops||[]){var n=b.hydrate_troop_metadata(a,m,l._data.troops[m],l._data.side);l.forces.push(n)}l._data.troops=JSON.parse(JSON.stringify(l.forces));var o=100,p=0;_.each(l.forces,function(a){a.speed<o&&(o=a.speed);var b=a.vision||a.range;b>p&&(p=b)}),l.speed=o,l.vision=p,l.data_expanded=!0}return l},b.hydrate_troop_metadata=function(a,b,c,d){var e=a.game_options.forces_data||[],f={},g=b;_.isObject(b)&&(g=b.name,f=b);var h=_.find(e,function(a){return"all"==a.side&&a.name==g})||{},i=_.find(e,function(a){return a.side==d&&a.name==g})||{},j=$.extend({},h,i,f);return j?j.count=c||1:(console.error("troop_data not found for: "+g),j={name:b,count:c,side:d}),j},b.raze_or_loot=function(a,c,d){d.additions=d.additions||[],c.loot=c.loot||{};var e=b.tile_has(d,"farm",!0),f=b.tile_has(d,"pillaged"),g=b.tile_has(d,"looted");if(c._data.try_to_pillage&&(e&&!f?(c.loot.food=c.loot.food||0,c.loot.herbs=c.loot.herbs||0,c.loot.food+=100*e,c.loot.herbs+=20*e,d.additions.push("pillaged")):"city"!=d.type||f?d.population&&(c.loot.food=c.loot.food||0,c.loot.food+=3,d.additions.push("pillaged")):(c.loot.food=c.loot.food||0,c.loot.wood=c.loot.wood||0,c.loot.metal=c.loot.metal||0,c.loot.skins=c.loot.skins||0,c.loot.food+=10,c.loot.wood+=10,c.loot.metal+=10,c.loot.skins+=10,d.additions.push("pillaged"),d.population>3e3&&b.random()>.8&&(c.loot.gold=c.loot.gold||0,c.loot.gold+=1))),c._data.try_to_loot&&(b.tile_has(d,"storage")||d.loot)){c.loot=c.loot||{};for(var h in d.loot)c.loot[h]=c.loot[h]||0,c.loot[h]+=d.loot[h],d.loot[h]=0;!e||f||g?"city"!=d.type||g||(c.loot.food=c.loot.food||0,c.loot.wood=c.loot.wood||0,c.loot.metal=c.loot.metal||0,c.loot.skins=c.loot.skins||0,c.loot.food+=5,c.loot.wood+=5,c.loot.metal+=5,c.loot.skins+=5,d.population>3e3&&b.random()>.9&&(c.loot.gold=c.loot.gold||0,c.loot.gold+=1)):(c.loot.food=c.loot.food||0,c.loot.herbs=c.loot.herbs||0,c.loot.food+=25*e,c.loot.herbs+=6*e),g||d.additions.push("looted")}},b.remove_entity=function(a,c){var d=_.indexOf(a.entities,c);if(d>-1){var e=c.x,f=c.y,g=b.tile(a,e,f);if(g&&(g.additions=g.additions||[],g.additions.push({name:"unit corpse",unit:c._data})),c.loot){g.loot=g.loot||{};for(var h in c.loot)g.loot[h]=g.loot[h]||0,g.loot[h]+=c.loot[h]}a.scheduler.remove(a.entities[d]),a.entities=_.reject(a.entities,c),b.draw_tile(a,e,f)}},b.find_tile_by_unit_goals=function(a,c){var d=c.vision||c.range||3;c._data.goals=c._data.goals||{};var e=b.tile(a,c.x,c.y);if(c._data.goals.weak_enemies||c._data.goals.all_enemies)var f={side:"enemy",range:d,return_multiple:!0},g=b.find_unit_by_filters(a,c,f);var h=b.surrounding_tiles(a,c.x,c.y,d),i=[];_.each(h,function(a){var d=0,e=b.tile_has(a,"pillaged")||b.tile_has(a,"looted"),f=b.tile_has(a,"tower")?1:0,h=Math.min(2,b.tile_has(a,"wall",!0)),j=_.isObject(a.loot)&&!e?1:0,k="city"!=a.type||e?0:1,l=b.tile_has(a,"farm")&&!e?1:0,m=a.population&&!e?1:0;if(d+=f*(c._data.goals.towers||0),d+=h*(c._data.goals.walls||0),d+=j*(c._data.goals.loot||0),d+=k*(c._data.goals.city||0),d+=l*(c._data.goals.farm||0),d+=m*(c._data.goals.population||0),g.target.length&&(c._data.goals.weak_enemies||c._data.goals.all_enemies)){var n=_.filter(g.target,function(b){return b.x==a.x&&b.y==a.y&&!b.is_dead});d+=n.length*Math.min(c._data.goals.all_enemies,2)}d>0&&(d-=c.times_moved_to_tile(a.x,a.y));var o=c.waypoint_weight||0;d>o&&i.push({x:a.x,y:a.y,weight:d})});var j=!1;0==i.length&&c.waypoint?j=c.waypoint:i.length>0&&i.sort(function(a,b){return a.weight-b.weight}),i&&i.length&&(j=_.last(i),j.weight||(j=!1),j.x==e.x&&j.y==e.y&&(j=!1));var k=_.find(g.target,function(a){return a.x==c.x&&a.y==c.y});return{tile:j,enemy:k}};var d=function(a){this._game=a};d.prototype.describe=function(){return"Screen"},d.prototype.getSpeed=function(){return 80},d.prototype.act=function(){var a=this,c=a._game;if(0==c.data.tick_count&&0==b.entities(c).length)return void c.engine.lock();c.data.tick_count++,b.update_ui_display(c),void 0!==c.game_options.game_over_time&&c.data.tick_count>=c.game_options.game_over_time&&b.game_over(c),void 0!==c.data.game_over_at_tick&&c.data.tick_count>=c.data.game_over_at_tick&&(c.engine.lock(),b.game_over_loot_report(c));var d=null,e={then:function(a){d=a}},f=function(a){c.data.in_progress?a():setTimeout(function(){f(a)},c.game_options.delay_between_ticks||500)};return setTimeout(function(){f(d)},c.game_options.delay_between_ticks||500),e};var e=function(a,b,c,d,e){this.x=b,this.y=c,this._game=a,this._id=d,this._symbol=e.symbol||"@",this._data=e,this._draw(),this.strategy="",this.previous_tiles_visited=[]};e.prototype.describe=function(){return this._data.name+" (<span style='color:"+this._data.side+"'>"+this._symbol+"</span>)"},e.prototype.getSpeed=function(){return this.speed||this._data.speed||40},e.prototype.setPosition=function(a,b){return this.x=a,this.y=b,this},e.prototype.getPosition=function(){return{x:this.x,y:this.y}},e.prototype.act=function(){},e.prototype.track_move=function(a){this.previous_tiles_visited.push(a),this.previous_tiles_visited=_.last(this.previous_tiles_visited,40)},e.prototype.times_moved_to_tile=function(a,b){var c=_.filter(this.previous_tiles_visited,function(c){return c.x==a&&c.y==b});return c.length},e.prototype.try_to_move_to_and_draw=function(a,c){var d=this._game,e=this,f=b.tile_is_traversable(d,a,c,e._data.move_through_impassable);if(f){var g=b.find_unit_by_filters(d,e,{location:{x:a,y:c}});if(g&&g.target&&g.target.data&&g.target.data.side&&g.target.data.side!=e.data.side&&(f=b.entity_attacks_entity(d,e,g.target,b.log_message_to_user)),f){var h=e.x,i=e.y;e.x=a,e.y=c;var j=b.tile(d,a,c);(e._data.try_to_loot||e._data.try_to_pillage)&&("city"==j.type||b.tile_has(j,"dock")||b.tile_has(j,"farm")||b.tile_has(j,"storage")||j.loot)&&b.raze_or_loot(d,e,j);var k=0,l=0;e._side==j.side&&(k=b.tile_has(j,"wall",!0),l=b.tile_has(j,"tower",!0)),e.protected_by_walls=k,e.in_towers=l,b.draw_tile(d,h,i),e._draw(),e.track_move(j)}}return f},e.prototype.bump=function(a,b){},e.prototype._draw=function(a,c){var d,e;d=void 0===a?this.x:a,e=void 0===c?this.y:c,b.draw_tile(this._game,d,e,this._symbol||"@",this._data.color||"#000",this._data.side)},e.prototype.getX=function(){return this.x},e.prototype.getY=function(){return this.y},e.prototype.try_move=function(a,b,c){var d=!1,e=a.cells[b];return e&&(e=e[c],e&&!e.impassable&&(d=!0)),d},e.prototype.execute_plan=function(){var a,c,d=this,e=d._game,f=d._data.plan||"seek closest";if("seek closest"==f)a={side:"enemy",filter:"closest",range:20,plan:f,backup_strategy:d._data.backup_strategy},c=b.find_unit_by_filters(e,d,a),b.movement_strategies.seek(e,d,c,a);else if("goal based"==f){var g=b.find_tile_by_unit_goals(e,d);g.enemy?b.entity_attacks_entity(e,d,g.enemy,b.log_message_to_user):g.tile&&(d.waypoint&&d.waypoint.x==d.x&&d.waypoint.y==d.y?(d.waypoint=null,d.waypoint_weight=null):(d.waypoint=g.tile,d.waypoint_weight=g.tile.weight),a={side:"enemy",filter:"closest",when_arrive:"goal based",plan:f,backup_strategy:d._data.backup_strategy},b.movement_strategies.head_towards_2(e,d,{location:g.tile},a))}else if("vigilant"==f)a={side:"enemy",filter:"closest",range:3,plan:f,backup_strategy:d._data.backup_strategy},c=b.find_unit_by_filters(e,d,a),b.movement_strategies.seek(e,d,c,a);else if("seek weakest"==f)a={side:"enemy",filter:"weakest",range:20,plan:f,backup_strategy:d._data.backup_strategy},c=b.find_unit_by_filters(e,d,a),b.movement_strategies.seek(e,d,c,a);else if("run away"==f)a={side:"enemy",filter:"closest",range:12,plan:f,backup_strategy:"vigilant"},c=b.find_unit_by_filters(e,d,a),b.movement_strategies.avoid(e,d,c,a);else if("invade city"==f){var h=_.find(e.data.buildings,function(a){return"city"==a.type||"city2"==a.type});a={side:"enemy",filter:"closest",range:12,when_arrive:"goal based",plan:f,backup_strategy:d._data.backup_strategy},b.movement_strategies.head_towards(e,d,h,a)}else if("defend city"==f){var h=_.find(e.data.buildings,function(a){return"city"==a.type||"city2"==a.type});a={side:"enemy",filter:"closest",range:8,stop_if_cell_has:["tower","wall"],when_arrive:"goal based",plan:f,backup_strategy:d._data.backup_strategy},b.movement_strategies.head_towards(e,d,h,a)}else"wait"==f?b.movement_strategies.wait(e,d):b.movement_strategies.wander(e,d);b.update_unit_ui(e,d)};var f=function(a,b,c,d,f){e.call(this,a,b,c,d,f)};f.extend(e),f.prototype.act=function(){var a=this;a._id==c&&window.addEventListener("keydown",this),!a.is_dead&&a._data.plan&&a.execute_plan()},f.prototype.handleEvent=function(a){var c=this,d=this._game,e=b.interpret_command_from_keycode(a.keyCode,c);if(e.ignore)return void window.removeEventListener("keydown",c);if(e.func&&e.func(d,c),e.movement){var f=c.x+e.movement[0],g=c.y+e.movement[1],h=c.try_move(d,f,g);h&&c.try_to_move_to_and_draw(f,g),window.removeEventListener("keydown",this)}},f.prototype.execute_action=function(a,b){var c=a.cells[b.x][b.y];console.log("Player at x: "+b.x+", y: "+b.y),console.log("Cell value here is: ["+JSON.stringify(c)+"]")};var g=function(a,b,c,d,f){e.call(this,a,b,c,d,f)};g.extend(e),g.prototype.act=function(){var a=this;!a.is_dead&&a._data.plan&&a.execute_plan()}}(Battlebox);
//# sourceMappingURL=battlebox.min.js.map